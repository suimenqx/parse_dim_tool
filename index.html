<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>离线表格分析器 V17.0 (Smart Parser)</title>
    <style>
        /* --- Design Tokens --- */
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --primary-soft: #e8f1ff;
            --bg-app: #f5f6f8;
            --bg-card: #fff;
            --bg-elevated: #f9fafb;
            --border: #e5e7eb;
            --border-strong: #d1d5db;
            --text-strong: #0f172a;
            --text-mid: #475569;
            --text-weak: #94a3b8;
            --radius-sm: 6px;
            --radius-md: 10px;
            --shadow-xs: 0 6px 18px rgba(15, 23, 42, 0.06);
            --shadow-md: 0 18px 42px rgba(15, 23, 42, 0.1);
            --highlight-row: #eef4ff;
            --selection-bg: rgba(37, 99, 235, 0.14);
            --z-modal: 1200;
        }

        [data-theme="dark"] {
            --primary: #60a5fa;
            --primary-hover: #3b82f6;
            --primary-soft: #1d2a44;
            --bg-app: #0b1628;
            --bg-card: #0f1f38;
            --bg-elevated: #0d1a2d;
            --border: #1f2d45;
            --border-strong: #263651;
            --text-strong: #f8fafc;
            --text-mid: #cbd5e1;
            --text-weak: #94a3b8;
            --shadow-xs: 0 6px 18px rgba(0, 0, 0, 0.35);
            --shadow-md: 0 18px 42px rgba(0, 0, 0, 0.45);
            --highlight-row: #132545;
            --selection-bg: rgba(96, 165, 250, 0.22);
        }

        * { box-sizing: border-box; outline: none; }
        body { margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-family: "Inter", "SF Pro Display", -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-app); color: var(--text-strong); font-size: 13px; line-height: 1.5; }
        body.modal-open { overflow: hidden; }
        a { color: var(--primary); text-decoration: none; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 999px; }
        ::-webkit-scrollbar-track { background: transparent; }
        [data-theme="dark"] ::-webkit-scrollbar-thumb { background: #475569; }

        .flex { display: flex; }
        .flex-col { display: flex; flex-direction: column; }
        .flex-1 { flex: 1; min-height: 0; min-width: 0; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-1 { gap: 4px; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        .w-full { width: 100%; }
        .hidden { display: none !important; }
        .eyebrow { font-size: 11px; letter-spacing: 0.4px; text-transform: uppercase; color: var(--text-weak); }
        .muted { color: var(--text-weak); }
        .bold { font-weight: 700; }

        button { display: inline-flex; align-items: center; justify-content: center; padding: 0 12px; height: 34px; font-size: 13px; font-weight: 600; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text-strong); cursor: pointer; transition: all 0.12s ease; white-space: nowrap; }
        button:hover { background: var(--bg-elevated); border-color: var(--border-strong); }
        button.primary { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 10px 20px rgba(37,99,235,0.15); }
        button.primary:hover { background: var(--primary-hover); }
        .btn-soft-primary { background: var(--primary-soft); color: var(--primary); border: 1px solid rgba(37,99,235,0.25); box-shadow: none; }
        .btn-soft-primary:hover { background: rgba(37,99,235,0.12); border-color: rgba(37,99,235,0.35); }
        button.icon-btn { padding: 0; width: 32px; height: 32px; border-radius: 10px; border: 1px solid transparent; background: transparent; color: var(--text-mid); }
        button.icon-btn:hover { background: var(--bg-elevated); color: var(--text-strong); }
        button.sm { height: 28px; padding: 0 9px; font-size: 12px; }
        button.ghost { border-color: transparent; background: transparent; box-shadow: none; }
        button.danger { color: #ef4444; border-color: rgba(239,68,68,0.25); }
        button.danger:hover { background: rgba(239,68,68,0.08); }
        button:disabled { opacity: 0.55; cursor: not-allowed; box-shadow: none; }
        button.primary:disabled { background: var(--primary); }

        label { display: block; font-size: 12px; font-weight: 700; color: var(--text-mid); margin-bottom: 6px; }
        input[type="text"], select, textarea { width: 100%; height: 36px; padding: 0 10px; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-strong); border-radius: 8px; font-family: inherit; font-size: 13px; transition: all 0.12s ease; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-soft); }
        textarea { height: auto; resize: none; }
        .input-group { display: flex; width: 100%; }
        .input-group > input { border-top-right-radius: 0; border-bottom-right-radius: 0; z-index: 1; }
        .input-group > button { border-top-left-radius: 0; border-bottom-left-radius: 0; margin-left: -1px; background: var(--bg-elevated); border-color: var(--border); }

        .multi-select { min-height: 36px; padding: 6px; display: flex; flex-wrap: wrap; gap: 6px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-card); cursor: pointer; align-items: center; transition: border-color 0.12s ease; }
        .multi-select:hover { border-color: var(--border-strong); }
        .chip { background: var(--primary-soft); color: var(--primary); border: 1px solid rgba(37, 99, 235, 0.2); padding: 0 10px; height: 24px; border-radius: 999px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; }
        .chip .x { font-weight: 900; font-size: 12px; color: var(--text-mid); }
        .placeholder { color: var(--text-weak); margin-left: 6px; font-style: italic; }
        .help-icon { display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; border-radius: 50%; background: var(--text-weak); color: white; font-size: 10px; cursor: help; margin-left: 6px; vertical-align: middle; }
        .helper-link { color: var(--primary); cursor: pointer; font-weight: 600; }

        .checkbox-row { display: flex; align-items: center; padding: 8px 10px; cursor: pointer; user-select: none; width: 100%; border-radius: 10px; transition: background 0.12s ease; }
        .checkbox-row:hover { background: var(--bg-elevated); }
        .checkbox-row input { margin: 0 10px 0 0; accent-color: var(--primary); width: 16px; height: 16px; cursor: pointer; }

        /* Layout */
        .topbar { height: 52px; background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 0 18px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; box-shadow: var(--shadow-xs); }
        .brand { display: flex; align-items: center; gap: 10px; }
        .brand-badge { width: 32px; height: 32px; background: linear-gradient(135deg, #2563eb, #0ea5e9); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; box-shadow: 0 10px 24px rgba(37,99,235,0.2); }
        .app-shell { display: flex; width: 100%; height: 100vh; background: var(--bg-app); }
        .sidebar { width: 340px; min-width: 280px; background: var(--bg-card); border-right: 1px solid var(--border); display: flex; flex-direction: column; transition: width 0.18s ease, min-width 0.18s ease; box-shadow: var(--shadow-xs); z-index: 10; overflow: hidden; }
        .sidebar.collapsed { width: 56px; min-width: 56px; }
        .sidebar.collapsed .sidebar-tabs, .sidebar.collapsed .sidebar-scroll, .sidebar.collapsed .sidebar-content, .sidebar.collapsed .segmented, .sidebar.collapsed .sidebar-heading { display: none; }
        .sidebar.collapsed .logo-text { display: none; }
        .sidebar.collapsed .sidebar-toggle { justify-content: center; }
        .sidebar-top { display: flex; align-items: center; justify-content: space-between; padding: 14px 14px 12px 14px; }
        .sidebar-heading { font-weight: 700; color: var(--text-mid); }
        .sidebar-header { height: 56px; padding: 0 14px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); }
        .logo { display: flex; align-items: center; gap: 10px; font-weight: 800; color: var(--text-strong); font-size: 15px; }
        .logo-icon { width: 32px; height: 32px; background: linear-gradient(135deg, var(--primary), var(--primary-hover)); color: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 800; box-shadow: 0 6px 18px rgba(37,99,235,0.2); }
        .sidebar-toggle { cursor: pointer; padding: 8px 0; user-select: none; display: inline-flex; align-items: center; gap: 10px; }
        .sidebar-tabs { padding: 4px 10px 0 10px; margin-bottom: 2px; }
        .seg-control { display: flex; background: var(--bg-elevated); padding: 4px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 0; }
        .seg-btn { flex: 1; height: 32px; border-radius: 8px; border: none; background: transparent; color: var(--text-mid); font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.15s; }
        .seg-btn.active { background: var(--bg-card); color: var(--primary); box-shadow: var(--shadow-xs); border: 1px solid var(--border); }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 0; }
        .sidebar-scroll { flex: 1; overflow-y: auto; padding: 0 10px 10px 10px; display:flex; flex-direction:column; gap:8px; margin-top:0; }
        .sidebar-scroll .sidebar-pane { margin-top: 0; }
        .sidebar-scroll .card { margin-top: 0; }
        .sidebar-scroll .card:first-child { margin-top: 0; }
        .sidebar-pane { display: none; }
        .sidebar-pane.active { display: block; }

        /* Main */
        .main-content { flex: 1; display: flex; flex-direction: column; min-width: 0; position: relative; }
        .top-nav { height: 56px; background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 0 18px; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow-xs); }
        .doc-tabs { display: flex; align-items: center; gap: 4px; overflow-x: auto; max-width: 60%; }
        .doc-tab { height: 32px; padding: 0 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-mid); cursor: pointer; transition: all 0.2s; border: 1px solid transparent; }
        .doc-tab:hover { background: var(--bg-hover); }
        .doc-tab.active { background: var(--primary-soft); color: var(--primary); font-weight: 700; border-color: rgba(37,99,235,0.1); }
        .doc-tab-close { font-size: 14px; opacity: 0.6; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; }
        .doc-tab-close:hover { background: rgba(0,0,0,0.08); opacity: 1; }

        /* Cards & Blocks */
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); box-shadow: var(--shadow-xs); margin-bottom: 10px; overflow: hidden; }
        .card-header { padding: 10px 12px; font-weight: 800; color: var(--text-strong); display: flex; align-items: center; justify-content: space-between; background: var(--bg-elevated); }
        .card-body { padding: 12px; }
        .panel-header { padding: 12px 14px; font-weight: 800; color: var(--text-strong); display: flex; align-items: center; justify-content: space-between; background: var(--bg-elevated); border-bottom: 1px solid var(--border); }
        .toolbar { display: flex; gap: 8px; }
        .textarea-shell { position: relative; display: flex; flex-direction: column; }
        #rawInput { min-height: 120px; max-height: 600px; height: 320px; border-radius: 12px; padding: 12px; font-family: "JetBrains Mono", Consolas, monospace; background: var(--bg-elevated); border: 1px solid var(--border); flex: 0 0 auto; }
        .input-resizer { height: 6px; cursor: ns-resize; display: flex; align-items: center; justify-content: center; margin: 4px 0; border-radius: 3px; transition: background 0.15s ease; flex-shrink: 0; }
        .input-resizer:hover { background: var(--primary-soft); }
        .input-resizer::after { content: ''; width: 40px; height: 3px; background: var(--border); border-radius: 2px; opacity: 0.6; }
        .input-resizer:hover::after { background: var(--primary); opacity: 1; }
        .input-resizer.dragging { background: var(--primary-soft); cursor: ns-resize; }
        .input-resizer.dragging::after { background: var(--primary); opacity: 1; }
        .floating-actions { position: absolute; right: 10px; bottom: 10px; display: flex; gap: 6px; background: rgba(255,255,255,0.9); backdrop-filter: blur(6px); padding: 6px; border-radius: 999px; border: 1px solid var(--border); box-shadow: var(--shadow-xs); }
        [data-theme="dark"] .floating-actions { background: rgba(15,23,42,0.85); }

        /* Accordion */
        .accordion { display: flex; flex-direction: column; gap: 8px; }
        .acc-item { border: 1px solid var(--border); border-radius: var(--radius-md); background: var(--bg-card); box-shadow: var(--shadow-xs); overflow: hidden; }
        .acc-head { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; cursor: pointer; background: var(--bg-elevated); font-weight: 700; }
        .acc-head .muted { font-size: 12px; }
        .acc-body { padding: 10px 12px 12px 12px; display: none; }
        .acc-item.open .acc-body { display: block; }
        .acc-item.open .acc-head { color: var(--primary); }

        /* Preview */
        .preview-area { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; background: linear-gradient(180deg, var(--bg-app) 0%, var(--bg-elevated) 100%); }
        .meta-tag { background: rgba(15, 23, 42, 0.04); padding: 4px 8px; border-radius: 999px; font-size: 11px; color: var(--text-mid); }

        .table-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; margin: 0 0 14px 0; display: flex; flex-direction: column; overflow: visible; box-shadow: var(--shadow-xs); }
        .table-meta { padding: 10px 14px; background: var(--bg-elevated); border-bottom: 1px solid var(--border); display: flex; gap: 10px; font-size: 12px; color: var(--text-mid); align-items: center; flex-wrap: wrap; }
        .filterable-th { cursor: pointer; position: relative; }
        .filterable-th .th-label { display: inline-flex; align-items: center; gap: 6px; }
        .filterable-th .th-filter-dot { display: inline-block; width: 8px; height: 8px; background: var(--primary); border-radius: 50%; }
        .filterable-th .th-filter-clear { font-size: 11px; color: var(--text-tertiary); cursor: pointer; padding: 2px 4px; border-radius: 6px; }
        .filterable-th .th-filter-clear:hover { color: var(--primary); background: var(--bg-hover); }
        table { border-collapse: separate; border-spacing: 0; width: 100%; font-family: "JetBrains Mono", Consolas, monospace; font-size: 12px; cursor: cell; user-select: none; display: block; overflow-x: auto; }
        th, td { padding: 9px 12px; border-bottom: 1px solid var(--border); white-space: nowrap; text-align: left; }
        th { background: linear-gradient(180deg, rgba(37,99,235,0.06), rgba(37,99,235,0)); color: var(--text-strong); font-weight: 700; position: sticky; top: 0; z-index: 5; }
        tbody tr:nth-child(even) td { background: rgba(15, 23, 42, 0.015); }
        tbody tr:hover td { background: rgba(37,99,235,0.06); }
        tr.highlight-row td { background: var(--highlight-row); }
        td.selected-cell { background: var(--selection-bg) !important; }
        td { max-width: 260px; overflow: hidden; text-overflow: ellipsis; }
        td:hover { position: relative; }
        td[data-full]:hover::after { content: attr(data-full); position: absolute; left: 0; bottom: 100%; transform: translateY(-4px); background: var(--text-strong); color: var(--bg-card); padding: 6px 8px; border-radius: 6px; font-size: 11px; white-space: nowrap; z-index: 20; box-shadow: var(--shadow-xs); }

        /* Floating */
        #tooltip { position: fixed; background: #1e293b; color: white; padding: 8px 12px; border-radius: 10px; font-size: 12px; z-index: 9999; pointer-events: none; opacity: 0; transition: opacity 0.1s; max-width: 260px; line-height: 1.4; box-shadow: var(--shadow-md); }
        #tooltip.show { opacity: 1; }
        #toast { position: fixed; bottom: 24px; right: 24px; background: #10b981; color: white; padding: 11px 16px; border-radius: 10px; font-weight: 700; z-index: 9999; transform: translateY(100px); transition: transform 0.3s; box-shadow: var(--shadow-md); }
        #toast.show { transform: translateY(0); }
        #toast.error { background: #ef4444; }
        .filter-popover { position: fixed; z-index: var(--z-modal); background: var(--bg-card); border: 1px solid var(--border); box-shadow: var(--shadow-md); border-radius: 7px; width: 150px; padding: 4px; display: flex; flex-direction: column; gap: 3px; font-size: 10px; }
        .filter-popover .fp-header { display: flex; align-items: center; justify-content: space-between; font-weight: 800; color: var(--text-strong); font-size: 10px; line-height: 1.1; }
        .filter-popover .fp-header button { border: none; background: transparent; cursor: pointer; font-size: 12px; color: var(--text-tertiary); line-height: 1; }
        .filter-popover input { width: 100%; height: 20px; border: 1px solid var(--border); border-radius: 5px; padding: 2px 4px; font-size: 10px; background: var(--bg-input); color: var(--text-main); }
        .filter-popover .fp-actions { display: flex; justify-content: flex-end; gap: 3px; }
        .filter-popover .fp-actions .sm, .filter-popover .fp-actions .primary.sm { padding: 2px 6px; font-size: 10px; height: 20px; }
        td.editing { position: relative; }
        .cell-editor { position: absolute; inset: 2px; width: calc(100% - 4px); height: calc(100% - 4px); box-sizing: border-box; border: 1px solid var(--primary); border-radius: 4px; padding: 2px 4px; font-family: "JetBrains Mono", Consolas, monospace; font-size: 12px; background: var(--bg-card); color: var(--text-main); }

        /* Modals */
        .modal-bg { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.45); backdrop-filter: blur(4px); z-index: var(--z-modal); display: flex; align-items: center; justify-content: center; padding: 24px; }
        .modal { background: var(--bg-card); width: 520px; max-height: 82vh; border-radius: 14px; border: 1px solid var(--border); box-shadow: var(--shadow-md); display: flex; flex-direction: column; overflow: hidden; }

        .fullscreen-modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.55); backdrop-filter: blur(6px); z-index: var(--z-modal); display: flex; align-items: center; justify-content: center; padding: 24px; }
        .join-shell { width: min(1200px, 94vw); height: 88vh; background: var(--bg-card); border-radius: 16px; box-shadow: var(--shadow-md); display: flex; flex-direction: column; border: 1px solid var(--border); overflow: hidden; }
        .join-head { padding: 16px 18px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: var(--bg-elevated); gap: 12px; }
        .join-head-left { display: flex; flex-direction: column; gap: 2px; min-width: 0; }
        .join-title-row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .join-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .join-meta { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 14px 18px 4px 18px; }
        .join-grid { flex: 1; display: grid; grid-template-columns: 0.75fr 1.5fr 0.75fr; gap: 14px; padding: 8px 18px 12px 18px; overflow: hidden; }
        .join-col, .join-map { background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: var(--shadow-xs); }
        .join-col-head { padding: 12px; font-weight: 700; display: flex; flex-direction: column; gap: 8px; border-bottom: 1px solid var(--border); }
        .join-col-title { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
        .join-col-tools { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
        .join-search { height: 30px; font-size: 12px; min-width: 120px; flex: 1; }
        .join-list { flex: 1; overflow-y: auto; padding: 8px 10px; }
        .join-map-head { padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: 700; }
        .join-map-body { flex: 1; padding: 12px; overflow-y: auto; display: grid; grid-template-rows: auto 1fr auto; gap: 10px; }
        .join-rel-card { background: var(--bg-card); border: 1px dashed var(--border-strong); border-radius: 10px; padding: 10px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 6px; }
        .join-order { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 10px; min-height: 72px; display: flex; flex-direction: column; gap: 6px; align-content: flex-start; }
        .join-chip { display: flex; align-items: center; gap: 10px; padding: 6px 10px; background: var(--primary-soft); border: 1px solid rgba(37,99,235,0.2); border-radius: 10px; cursor: grab; user-select: none; width: 100%; }
        .join-chip-main { display: inline-flex; align-items: center; gap: 8px; min-width: 0; }
        .join-chip-label { font-weight: 500; font-size: 11px; color: var(--text-mid); min-width: 140px; max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: left; }
        .join-chip-actions { display: inline-flex; align-items: center; gap: 6px; margin-left: auto; }
        .join-chip.dragging { opacity: 0.55; cursor: grabbing; }
        .join-alias { height: 22px; font-size: 11px; width: 96px; padding: 0 6px; border-radius: 4px; border: 1px solid var(--border-light); background: var(--bg-card); box-shadow: none; }
        .join-alias:focus { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-soft); }
        .je-row { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
        .je-rel-l, .je-rel-r { flex: 0 1 clamp(140px, 36%, 200px); width: clamp(140px, 36%, 200px); height: 30px; font-size: 12px; }
        .join-foot { padding: 12px 18px; border-top: 1px solid var(--border); background: var(--bg-elevated); display: flex; align-items: center; justify-content: space-between; }
        .join-toggle { display: inline-flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-weak); font-weight: 600; }
        .join-toggle input { width: 14px; height: 14px; accent-color: var(--primary); }
        .join-order-head { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 6px; }
        .join-order-tools { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
        .rel-meta-row { display: flex; align-items: center; justify-content: space-between; gap: 6px; font-size: 10px; line-height: 1.2; color: var(--text-weak); padding: 0; }
        .rel-meta { display: inline-flex; gap: 4px; align-items: center; }
        .join-warn { font-size: 12px; color: #f59e0b; padding: 0; }
        .join-warn.error { color: #ef4444; }
        .join-warn.ok { color: #10b981; }
        .join-foot-left { display: flex; flex-direction: column; gap: 4px; }
        .join-preview { font-size: 12px; color: var(--text-weak); }
        .join-hints { font-size: 11px; color: var(--text-weak); }

        /* Empty State */
        .empty { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; color: var(--text-weak); margin-top: 40px; }
        .empty svg { width: 120px; height: 120px; opacity: 0.5; }
    </style>
</head>
<body>

<div id="tooltip"></div>
<div id="toast">Ready</div>

<div class="app-shell">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo sidebar-toggle" id="sidebarToggle" title="点击折叠 / 展开侧栏" tabindex="0">
                <div class="logo-icon">T</div>
                <span class="logo-text">Smart Parser <span style="font-weight:400; opacity:0.6; font-size:12px;">v17.0</span></span>
            </div>
        </div>

        <div class="sidebar-tabs">
            <div class="seg-control">
                <button class="seg-btn active" data-tab-btn="data">数据源</button>
                <button class="seg-btn" data-tab-btn="config">配置规则</button>
            </div>
        </div>
        <div class="sidebar-scroll">
            <div class="sidebar-pane active" data-tab="data">
                <div class="card" style="box-shadow:none;">
                    <div class="card-header" style="border-bottom:1px solid var(--border);">
                        <span class="card-title">数据源</span>
                        <span class="muted" style="font-size:12px;">粘贴/拖拽输入</span>
                    </div>
                    <div class="card-body">
                        <div class="textarea-shell">
                            <textarea id="rawInput" wrap="off" placeholder="请粘贴数据..." style="border:none; border-radius:12px; resize:none; line-height:1.5; white-space: pre; overflow-x: auto;"></textarea>
                            <div class="input-resizer" id="inputResizer" title="拖拽调整高度"></div>
                        </div>
                    </div>
                    <div class="card-body" style="border-top:1px solid var(--border); display:flex; align-items:center; justify-content:flex-start; gap:8px; padding-top:10px;">
                        <div class="flex gap-2" style="align-items:center; justify-content:flex-start; flex-wrap:nowrap;">
                            <button class="sm btn-soft-primary" id="parseBtn" style="min-width:72px;">解析</button>
                            <button class="sm btn-soft-primary" id="clearBtn" title="清空输入" style="min-width:72px;">清空</button>
                            <button class="icon-btn sm" id="sampleLink" title="加载示例并解析">⭐</button>
                            <button class="icon-btn sm" id="exportRawBtn" title="导出原始">📊</button>
                            <button class="icon-btn sm" id="exportTabBtn" title="导出页签">⬇</button>
                            <button class="icon-btn sm" id="importTabBtn" title="导入页签">⬆</button>
                            <input type="file" id="fileInputTab" class="hidden" accept=".json">
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-pane" data-tab="config">
                <div class="accordion">
                    <div class="acc-item open" data-acc="view">
                        <div class="acc-head">
                            <span>视图设置</span>
                            <span class="muted">控制展示范围</span>
                        </div>
                        <div class="acc-body">
                            <div class="control-block" style="margin-bottom:10px;">
                                <label>显示原始表</label>
                                <div class="multi-select" id="tablesTrigger"><span class="placeholder">加载中...</span></div>
                            </div>
                            <div class="control-block" style="margin-bottom:10px;">
                                <label class="flex justify-between">
                                    <span>启用 JOIN 视图</span>
                                    <span style="color:var(--primary); cursor:pointer;" id="manageViewsBtn">管理</span>
                                </label>
                                <div class="multi-select" id="viewsTrigger"><span class="placeholder">未启用</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="acc-item" data-acc="rules">
                        <div class="acc-head">
                            <span>规则引擎</span>
                            <span class="muted">过滤与高亮</span>
                        </div>
                        <div class="acc-body">
                            <div class="control-block" style="margin-bottom:10px;">
                                <label>配置目标表</label>
                                <select id="targetTableSelect"></select>
                            </div>
                            <div class="control-block" style="margin-bottom:10px;">
                                <label>关注列 / 显示列</label>
                                <div class="input-group">
                                    <input type="text" id="focusColsInput" placeholder="Col1, Col2...">
                                    <button id="selectColsBtn">选择</button>
                                </div>
                            </div>
                            <div class="control-block" style="margin-bottom:10px;">
                                <label>高亮规则 <span class="help-icon" data-tip="语法增强：&#10;• ID=1001 (精确)&#10;• CPU>90 (数值)&#10;• Msg:Error (包含)&#10;• A=1 B!=OK (组合)">?</span></label>
                                <input type="text" id="hlInput" placeholder="error | ID=1 | CPU>90">
                            </div>
                            <div class="control-block" style="margin-bottom:10px;">
                                <label>行过滤</label>
                                <input type="text" id="filterInput" placeholder="Status!=OK, Qty>0 ...">
                            </div>
                            <div class="control-block" style="margin-bottom:10px;">
                                <label>全局过滤</label>
                                <input type="text" id="globalFilter" placeholder="全局搜索 (支持 key=val)...">
                            </div>
                            <div class="control-block">
                                <label class="checkbox-row" id="toggleHlRow">
                                    <input type="checkbox" id="checkHl" checked>
                                    <span>启用高亮渲染</span>
                                </label>
                                <label class="checkbox-row" id="toggleOnlyHlRow">
                                    <input type="checkbox" id="checkOnlyHl">
                                    <span style="color:var(--primary);">仅显示高亮行 (Focus)</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="acc-item" data-acc="export">
                        <div class="acc-head">
                            <span>导出选项</span>
                            <span class="muted">Excel & 配置</span>
                        </div>
                        <div class="acc-body">
                            <div class="control-block" style="margin-bottom:10px;">
                                <label class="checkbox-row">
                                    <input type="checkbox" id="checkExpSelected">
                                    <span>仅导出勾选表</span>
                                </label>
                                <select id="expColSelect" style="margin-top:4px;">
                                    <option value="all">导出全量列</option>
                                    <option value="shown">仅导出展示列</option>
                                </select>
                            </div>
                            <div class="flex gap-2">
                                <button class="sm" id="exportConfigBtn" title="导出配置">导出配置</button>
                                <button class="sm" id="importConfigBtn" title="导入配置">导入配置</button>
                                <input type="file" id="fileInputConfig" class="hidden" accept=".json">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <nav class="top-nav">
            <div class="doc-tabs" id="tabsContainer"></div>
            <div class="flex items-center gap-2">
                <button class="icon-btn sm" id="addTabBtn" title="新建页签">＋</button>
                <div style="height:20px; width:1px; background:var(--border); margin:0 6px;"></div>
                <button class="icon-btn sm" id="themeBtn" title="切换主题">◑</button>
                <button class="primary sm" id="exportPrevBtn">导出预览 Excel</button>
            </div>
        </nav>
        <div class="preview-area" id="previewArea"></div>
    </main>
</div>

<!-- Modal Container (Blocking) -->
<div id="modalOverlay" class="modal-bg hidden">
    <div id="modalContent" class="modal"></div>
</div>
<div id="filterPopover" class="filter-popover hidden">
    <div class="fp-header">
        <span id="fpTitle"></span>
        <button id="fpClose" aria-label="关闭">×</button>
    </div>
    <input id="fpInput" placeholder="列过滤，包含关键字，忽略大小写">
    <div class="fp-actions">
        <button class="sm" id="fpClear">清除</button>
        <button class="primary sm" id="fpApply">应用</button>
    </div>
</div>

<!-- Fullscreen Join Designer -->
<div id="joinModal" class="fullscreen-modal hidden">
    <div class="join-shell">
        <div class="join-head">
            <div class="join-head-left">
                <div class="eyebrow">Join Designer</div>
                <div class="join-title-row">
                    <div style="font-weight:800; font-size:16px;" id="jeTitle">配置 JOIN 视图</div>
                    <div class="join-warn" id="jeWarn"></div>
                </div>
            </div>
            <div class="toolbar">
                <button class="sm" id="jeCancel">取消</button>
                <button class="primary sm" id="jeSave">保存视图</button>
            </div>
        </div>
        <div class="join-body">
            <div class="join-meta">
                <div>
                    <label>视图名称</label>
                    <input type="text" id="jeName" placeholder="e.g. StockReport">
                </div>
                <div>
                    <label>左表 (Source A)</label>
                    <select id="jeLeftTable"></select>
                </div>
                <div>
                    <label>右表 (Source B)</label>
                    <select id="jeRightTable"></select>
                </div>
            </div>
            <div class="join-grid">
                <div class="join-col">
                    <div class="join-col-head">
                        <div class="join-col-title">
                            <span>左表字段</span>
                            <label class="join-toggle"><input type="checkbox" id="jeLOnlySel">仅看已选</label>
                        </div>
                        <div class="join-col-tools">
                            <input id="jeLSearch" class="join-search" placeholder="搜索...">
                            <button class="sm" id="jeLAllFiltered" title="全选搜索结果">全选结果</button>
                            <button class="icon-btn sm" id="jeLAll" title="全选/反选">✓</button>
                        </div>
                    </div>
                    <div class="join-list" id="jeLList"></div>
                </div>

                <div class="join-map">
                    <div class="join-map-head">
                        <span>关联条件 (ON)</span>
                        <div class="flex gap-2">
                            <select id="jeType" class="sm" style="height:32px;">
                                <option value="inner">Inner Join · 仅匹配</option>
                                <option value="left">Left Join · 保留左表</option>
                            </select>
                            <button class="sm" id="jeAutoRel">自动匹配</button>
                            <button class="sm" id="jeAddRel">添加条件</button>
                        </div>
                    </div>
                    <div class="join-map-body">
                        <div id="jeRelContainer"></div>
                        <div>
                            <div class="join-order-head">
                                <div class="eyebrow">输出顺序</div>
                                <div class="join-order-tools">
                                    <button class="sm" id="jeOrderRebuild">重建</button>
                                    <button class="sm" id="jeOrderClear">清空</button>
                                    <button class="sm" id="jeOrderLeftOnly">只保留左</button>
                                    <button class="sm" id="jeOrderRightOnly">只保留右</button>
                                    <label class="join-toggle"><input type="checkbox" id="jeOrderShowL" checked>左</label>
                                    <label class="join-toggle"><input type="checkbox" id="jeOrderShowR" checked>右</label>
                                </div>
                            </div>
                            <div id="jeOrderList" class="join-order"></div>
                        </div>
                    </div>
                </div>

                <div class="join-col">
                    <div class="join-col-head">
                        <div class="join-col-title">
                            <span>右表字段</span>
                            <label class="join-toggle"><input type="checkbox" id="jeROnlySel">仅看已选</label>
                        </div>
                        <div class="join-col-tools">
                            <input id="jeRSearch" class="join-search" placeholder="搜索...">
                            <button class="sm" id="jeRAllFiltered" title="全选搜索结果">全选结果</button>
                            <button class="icon-btn sm" id="jeRAll" title="全选/反选">✓</button>
                        </div>
                    </div>
                    <div class="join-list" id="jeRList"></div>
                </div>
            </div>
        </div>
        <div class="join-foot">
            <div class="join-foot-left">
                <div class="muted" id="jeStatus">已选输出列: 0</div>
                <div class="join-preview" id="jePreview">预览: -</div>
                <div class="join-hints">快捷键: Enter 保存 · Esc 关闭 · / 搜索</div>
            </div>
            <div class="toolbar">
                <button class="sm" id="jeCancelFooter">取消</button>
                <button class="primary sm" id="jeSaveFooter">保存视图</button>
            </div>
        </div>
    </div>
</div>

<script>
/* --- Utils --- */
const $ = (id) => document.getElementById(id);
const createEl = (tag, cls) => { const e = document.createElement(tag); if(cls) e.className=cls; return e; };

const Tooltip = {
    el: $('tooltip'),
    init() {
        document.body.addEventListener('mouseenter', e => {
            if(e.target.classList.contains('help-icon')) this.show(e.target, e.target.dataset.tip);
        }, true);
        document.body.addEventListener('mouseleave', e => {
            if(e.target.classList.contains('help-icon')) this.hide();
        }, true);
    },
    show(target, text) {
        this.el.innerText = text; this.el.classList.add('show');
        const r = target.getBoundingClientRect();
        this.el.style.top = (r.top - 40) + 'px'; this.el.style.left = (r.left - 20) + 'px';
    },
    hide() { this.el.classList.remove('show'); }
};
Tooltip.init();

const Toast = {
    el: $('toast'),
    show(msg, isError = false) {
        this.el.textContent = msg;
        this.el.className = isError ? 'show error' : 'show';
        setTimeout(() => this.el.className = '', 2000);
    }
};

// Shared escape function (used for both XML and HTML)
const escapeXml = str => String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');

/* Date/time utils */
const DateTime = {
    now() { return new Date(); },
    formatTimestamp() {
        const d = this.now();
        return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
    }
};

/* Download helper */
const Download = {
    save(filename, content, type = 'text/plain') {
        const blob = content instanceof Blob ? content : new Blob([content], {type});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
    }
};

/* Exporter */
const Exporter = {
    escapeXml,
    getTimestamp: () => DateTime.formatTimestamp(),
    download: Download.save,
    sanitizeSheetName(name, used) {
        const maxLen = 31;
        let safe = (name || 'Sheet').replace(/[\\\/:?*\[\]]/g, '_').trim();
        if(!safe) safe = 'Sheet';
        safe = safe.substring(0, maxLen);
        let final = safe, i = 1;
        while(used.has(final)) {
            const suffix = `_${++i}`;
            final = safe.substring(0, maxLen - suffix.length) + suffix;
        }
        used.add(final);
        return final;
    },
    normalizeTables(tables) {
        const used = new Set();
        return (tables || []).map((t, idx) => {
            const name = this.sanitizeSheetName(t.name || `Sheet${idx+1}`, used);
            const headers = Array.isArray(t.headers) ? t.headers : [];
            const rows = (t.rows || []).map(r => Array.isArray(r) ? r : (r.data || r.d || []));
            return { name, headers, rows };
        });
    },
    buildSheetXml({headers=[], rows=[]}) {
        const cell = (v) => {
            if(v === null || v === undefined) v = '';
            const trimmed = String(v).trim();
            const numericLike = /^-?\d+(\.\d+)?([eE][+-]?\d+)?$/.test(trimmed);
            const hasLeadingZeros = /^0\d+/.test(trimmed) && !trimmed.startsWith('0.');
            const isNum = (typeof v === 'number' && Number.isFinite(v)) || (numericLike && !hasLeadingZeros);
            if(isNum) return `<c t="n"><v>${trimmed}</v></c>`;
            const text = this.escapeXml(String(v));
            return `<c t="inlineStr"><is><t xml:space="preserve">${text}</t></is></c>`;
        };
        const rowsXml = [];
        let rowNo = 1;
        if(headers.length) rowsXml.push(`<row r="${rowNo++}">${headers.map(cell).join('')}</row>`);
        rows.forEach((r) => rowsXml.push(`<row r="${rowNo++}">${(r || []).map(cell).join('')}</row>`));
        return `<?xml version="1.0" encoding="UTF-8"?>` +
            `<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">` +
            `<sheetData>${rowsXml.join('')}</sheetData>` +
            `</worksheet>`;
    },
    buildWorkbookXml(sheets) {
        const sheetXml = sheets.map((s, i) => `<sheet name="${this.escapeXml(s.name)}" sheetId="${i+1}" r:id="rId${i+1}"/>`).join('');
        return `<?xml version="1.0" encoding="UTF-8"?>` +
            `<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">` +
            `<sheets>${sheetXml}</sheets></workbook>`;
    },
    buildWorkbookRels(count) {
        const rels = Array.from({length: count}, (_, i) => `<Relationship Id="rId${i+1}" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet${i+1}.xml"/>`).join('');
        return `<?xml version="1.0" encoding="UTF-8"?>` +
            `<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">${rels}</Relationships>`;
    },
    buildContentTypes(count) {
        const sheets = Array.from({length: count}, (_, i) => `<Override PartName="/xl/worksheets/sheet${i+1}.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>`).join('');
        return `<?xml version="1.0" encoding="UTF-8"?>` +
            `<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">` +
            `<Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>` +
            `<Default Extension="xml" ContentType="application/xml"/>` +
            `<Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>` +
            `${sheets}</Types>`;
    },
    buildRootRels() {
        return `<?xml version="1.0" encoding="UTF-8"?>` +
            `<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">` +
            `<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>` +
            `</Relationships>`;
    },
    makeZip(files) {
        const encoder = new TextEncoder();
        const toBytes = v => v instanceof Uint8Array ? v : encoder.encode(v);
        const crcTable = (() => {
            const t = new Uint32Array(256);
            for(let n=0; n<256; n++) {
                let c = n;
                for(let k=0; k<8; k++) c = (c & 1) ? (0xedb88320 ^ (c >>> 1)) : (c >>> 1);
                t[n] = c >>> 0;
            }
            return t;
        })();
        const crc32 = bytes => {
            let c = 0xffffffff;
            for(let i=0; i<bytes.length; i++) c = crcTable[(c ^ bytes[i]) & 0xff] ^ (c >>> 8);
            return (c ^ 0xffffffff) >>> 0;
        };
        const dosDateTime = () => {
            const d = new Date();
            const time = (d.getHours() << 11) | (d.getMinutes() << 5) | Math.floor(d.getSeconds() / 2);
            const date = ((d.getFullYear() - 1980) << 9) | ((d.getMonth() + 1) << 5) | d.getDate();
            return { time, date };
        };
        const { time, date } = dosDateTime();
        const fileParts = [], centralParts = [];
        let offset = 0;
        files.forEach(f => {
            const nameBytes = encoder.encode(f.name);
            const data = toBytes(f.data);
            const crc = crc32(data);
            const size = data.length;
            const local = new Uint8Array(30 + nameBytes.length);
            const lv = new DataView(local.buffer);
            lv.setUint32(0, 0x04034b50, true);
            lv.setUint16(4, 20, true); // version needed
            lv.setUint16(6, 0x0800, true); // UTF-8
            lv.setUint16(8, 0, true); // store
            lv.setUint16(10, time, true);
            lv.setUint16(12, date, true);
            lv.setUint32(14, crc, true);
            lv.setUint32(18, size, true);
            lv.setUint32(22, size, true);
            lv.setUint16(26, nameBytes.length, true);
            lv.setUint16(28, 0, true);
            local.set(nameBytes, 30);
            fileParts.push(local, data);

            const central = new Uint8Array(46 + nameBytes.length);
            const cv = new DataView(central.buffer);
            cv.setUint32(0, 0x02014b50, true);
            cv.setUint16(4, 20, true); // version made
            cv.setUint16(6, 20, true); // version needed
            cv.setUint16(8, 0x0800, true);
            cv.setUint16(10, 0, true);
            cv.setUint16(12, time, true);
            cv.setUint16(14, date, true);
            cv.setUint32(16, crc, true);
            cv.setUint32(20, size, true);
            cv.setUint32(24, size, true);
            cv.setUint16(28, nameBytes.length, true);
            cv.setUint16(30, 0, true); // extra
            cv.setUint16(32, 0, true); // comment
            cv.setUint16(34, 0, true); // disk start
            cv.setUint16(36, 0, true); // internal attr
            cv.setUint32(38, 0, true); // external attr
            cv.setUint32(42, offset, true); // offset of local header
            central.set(nameBytes, 46);
            centralParts.push(central);
            offset += local.length + size;
        });
        const centralSize = centralParts.reduce((s, p) => s + p.length, 0);
        const end = new Uint8Array(22);
        const ev = new DataView(end.buffer);
        ev.setUint32(0, 0x06054b50, true);
        ev.setUint16(4, 0, true); // disk number
        ev.setUint16(6, 0, true); // start disk
        ev.setUint16(8, files.length, true);
        ev.setUint16(10, files.length, true);
        ev.setUint32(12, centralSize, true);
        ev.setUint32(16, offset, true);
        ev.setUint16(20, 0, true); // comment length

        const totalLen = fileParts.reduce((s, p) => s + p.length, 0) + centralSize + end.length;
        const out = new Uint8Array(totalLen);
        let pos = 0;
        [...fileParts, ...centralParts, end].forEach(part => { out.set(part, pos); pos += part.length; });
        return out;
    },
    toExcel(tables, prefix='export') {
        if(!tables || !tables.length) return Toast.show('\u65e0\u6570\u636e\u53ef\u5bfc\u51fa', true);
        try {
            const sheets = this.normalizeTables(tables);
            const files = [
                { name: '[Content_Types].xml', data: this.buildContentTypes(sheets.length) },
                { name: '_rels/.rels', data: this.buildRootRels() },
                { name: 'xl/workbook.xml', data: this.buildWorkbookXml(sheets) },
                { name: 'xl/_rels/workbook.xml.rels', data: this.buildWorkbookRels(sheets.length) }
            ];
            sheets.forEach((s, i) => files.push({ name: `xl/worksheets/sheet${i+1}.xml`, data: this.buildSheetXml(s) }));
            const zip = this.makeZip(files);
            const blob = new Blob([zip], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            this.download(`${prefix}_${this.getTimestamp()}.xlsx`, blob, blob.type);
        } catch(e) {
            console.error(e);
            Toast.show('Excel \u5bfc\u51fa\u5931\u8d25', true);
        }
    },
    toJson(data, prefix='backup') { this.download(`${prefix}_${this.getTimestamp()}.json`, JSON.stringify(data, null, 2), 'application/json'); }
};
/* Core */
const Store = {
    state: { docs:[], activeId:null, theme:'light', globalViews:[] },
    init() {
        try { const s = JSON.parse(localStorage.getItem('v16_4_store')); if(s) this.state = s; } catch(e){}
        if(this.state.docs.length===0) this.addDoc();
        if(!this.state.globalViews) this.state.globalViews = [];
        this.applyTheme();
    },
    save() { localStorage.setItem('v16_4_store', JSON.stringify(this.state)); },
    addDoc() {
        this.state.docs.push({ id: Date.now().toString(), title: `Analysis ${this.state.docs.length+1}`, raw: "", ui: { displayTables:null, enabledViews:null, targetTable:"", rules:{}, columnFilters:{}, collapsedTables:{} } });
        this.state.activeId = this.state.docs[this.state.docs.length-1].id; this.save();
    },
    removeDoc(id) {
        if(this.state.docs.length<=1) return alert("至少保留一个页签");
        const idx = this.state.docs.findIndex(d=>d.id===id);
        this.state.docs.splice(idx,1);
        if(this.state.activeId===id) this.state.activeId = this.state.docs[Math.max(0,idx-1)].id;
        this.save();
    },
    curr() { 
        const d = this.state.docs.find(d=>d.id===this.state.activeId) || this.state.docs[0];
        if(!d.ui) d.ui = { displayTables:null, enabledViews:null, targetTable:"", rules:{}, columnFilters:{}, collapsedTables:{} };
        if(!d.ui.rules) d.ui.rules = {};
        if(!d.ui.columnFilters) d.ui.columnFilters = {};
        if(!d.ui.collapsedTables) d.ui.collapsedTables = {};
        return d;
    },
    updateUI(k, v) { this.curr().ui[k]=v; this.save(); },
    updateRule(table, field, value) {
        const ui = this.curr().ui; if(!ui.rules[table]) ui.rules[table] = {}; ui.rules[table][field] = value; this.save();
    },
    toggleTheme() { this.state.theme = this.state.theme==='light'?'dark':'light'; this.applyTheme(); this.save(); },
    applyTheme() { document.documentElement.setAttribute('data-theme', this.state.theme); }
};

/* Parser */
const Parser = {
    parse(txt) {
        try {
            const tables = []; let cur = null, inData = false, ranges = [];
            txt.split(/\r?\n/).forEach(line => {
                const trim = line.trim();
                if(line.toLowerCase().includes('table-data')) {
                    if(cur) tables.push(cur);
                    const m = /table-data\s+([^\s|]+)/i.exec(line);
                    cur = { name: m?m[1]:`T${tables.length+1}`, headers:[], rows:[], mode:'WS' }; inData = false; return;
                }
                if(!cur) return;
                if(trim.startsWith('validflag')) {
                    if(line.includes('\t')) { cur.mode='TAB'; cur.headers=trim.split('\t'); }
                    else if(line.includes(',') && !line.includes('  ')) { cur.mode='CSV'; cur.headers=trim.split(','); }
                    else { 
                        cur.mode='FIXED'; ranges=[]; const regex=/\S+/g; let m;
                        while((m=regex.exec(line))!==null) ranges.push({s:m.index, e:null});
                        for(let k=0;k<ranges.length;k++) ranges[k].e = (k===ranges.length-1)?99999:ranges[k+1].s;
                        cur.headers = ranges.map(r=>line.substring(r.s, Math.min(r.e, line.length)).trim());
                    }
                    inData = true; return;
                }
                if(inData) {
                    if(trim.startsWith('<') || trim.startsWith('[')) { tables.push(cur); cur=null; inData=false; return; }
                    if(!trim) return;
                    
                    let r = [];
                    // ENHANCEMENT: Try WS split first
                    const wsParts = line.trim().split(/\s+/);
                    if(wsParts.length === cur.headers.length) {
                        r = wsParts;
                    } else {
                        // Fallback
                        if(cur.mode==='FIXED') r=ranges.map(rg => (rg.s>=line.length)?'':line.substring(rg.s, Math.min(rg.e, line.length)).trim());
                        else if(cur.mode==='TAB') r=trim.split('\t');
                        else if(cur.mode==='CSV') r=trim.split(',');
                        else r=wsParts; 
                    }
                    while(r.length<cur.headers.length) r.push("");
                    cur.rows.push(r);
                }
            });
            if(cur) tables.push(cur);
            return tables;
        } catch(e) { console.error(e); Toast.show('解析出错', true); return []; }
    }
};

/* Joiner */
const Joiner = {
    resolve(name, rawTables, views, stack=[]) {
        if(stack.includes(name)) return null; 
        const raw = rawTables.find(t=>t.name===name);
        if(raw) return raw;
        const v = views.find(v=>v.view===name);
        if(v) return this.run(rawTables, v, views, [...stack, name]);
        return null;
    },
    parseSelectToken(token) {
        const raw = (token || '').trim();
        if(!raw) return null;
        let base = raw;
        let alias = '';
        const m = /^(.*?)(?:\s+as\s+|\s*:\s*)(.+)$/i.exec(raw);
        if(m) { base = m[1].trim(); alias = m[2].trim(); }
        let side = 'left';
        let col = base;
        if(base.includes('.')) {
            const parts = base.split('.');
            side = (parts[0] || 'left').toLowerCase();
            col = parts.slice(1).join('.').trim();
        }
        if(!col) return null;
        return { side, col, alias, raw };
    },
    buildSelectTokens(selectStr) {
        return (selectStr || '').replace(/\n/g, ',').split(',')
            .map(s => s.trim())
            .filter(Boolean)
            .map(t => this.parseSelectToken(t))
            .filter(Boolean);
    },
    stats(rawTables, cfg, views=[], stack=[]) {
        const L = this.resolve(cfg.left, rawTables, views, stack);
        const R = this.resolve(cfg.right, rawTables, views, stack);
        if(!L || !R) return null;
        const pairs = cfg.on.split(',').map(s => { const p=s.split('='); return p.length===2 ? [p[0].trim(), p[1].trim()] : null; }).filter(p=>p);
        if(!pairs.length) return null;
        const rIdx = new Map();
        R.rows.forEach(r => {
            const k = pairs.map(p => { const i=R.headers.indexOf(p[1]); return i>-1?r[i]:''; }).join('|||');
            if(!rIdx.has(k)) rIdx.set(k,[]); rIdx.get(k).push(r);
        });
        let matched = 0;
        let leftOnly = 0;
        const leftKeys = new Set();
        const lMap = new Map(L.headers.map((h,i)=>[h,i]));
        L.rows.forEach(lr => {
            const k = pairs.map(p => { const i=lMap.get(p[0]); return i!==undefined?lr[i]:''; }).join('|||');
            leftKeys.add(k);
            const matches = rIdx.get(k);
            if(matches) matched += matches.length;
            else leftOnly++;
        });
        let rightOnly = 0;
        rIdx.forEach((rows, k) => { if(!leftKeys.has(k)) rightOnly += rows.length; });
        const outRows = (cfg.type === 'left') ? matched + leftOnly : matched;
        return { matched, leftOnly, rightOnly, outRows, leftRows: L.rows.length, rightRows: R.rows.length };
    },
    run(rawTables, cfg, views=[], stack=[]) {
        const L = this.resolve(cfg.left, rawTables, views, stack);
        const R = this.resolve(cfg.right, rawTables, views, stack);
        if(!L || !R) return null;

        const pairs = cfg.on.split(',').map(s => { const p=s.split('='); return p.length===2 ? [p[0].trim(), p[1].trim()] : null; }).filter(p=>p);
        const cols = this.buildSelectTokens(cfg.select);
        
        const rIdx = new Map();
        R.rows.forEach(r => {
            const k = pairs.map(p => { const i=R.headers.indexOf(p[1]); return i>-1?r[i]:''; }).join('|||');
            if(!rIdx.has(k)) rIdx.set(k,[]); rIdx.get(k).push(r);
        });

        const rows = [];
        const lMap = new Map(L.headers.map((h,i)=>[h,i])), rMap = new Map(R.headers.map((h,i)=>[h,i]));
        L.rows.forEach(lr => {
            const k = pairs.map(p => { const i=lMap.get(p[0]); return i!==undefined?lr[i]:''; }).join('|||');
            const matches = rIdx.get(k);
            if(matches) matches.forEach(rr => rows.push({l:lr, r:rr}));
            else if(cfg.type==='left') rows.push({l:lr, r:null});
        });

        const headers = cols.map(t => t.alias || t.col || t.raw);
        const resRows = rows.map(({l, r}) => cols.map(t => {
            const src = (t.side === 'right' || t.side === 'r') ? 'right' : 'left';
            const col = t.col;
            if(src==='left') return l[lMap.get(col)]||'';
            return r ? (r[rMap.get(col)]||'') : '';
        }));
        return { name: `JOIN:${cfg.view}`, headers, rows: resRows, isView: true };
    }
};

/* Join Editor */
const JoinEditor = {
    state: {
        editIdx: -1,
        left: null,
        right: null,
        rels: [],
        lSel: [],
        rSel: [],
        order: [],
        dirty: false,
        initial: null,
        lOnlySel: false,
        rOnlySel: false,
        showL: true,
        showR: true,
        prevLeft: null,
        prevRight: null,
        titleBase: '',
        fromManageViews: false
    },
    metaCache: {},
    dragIdx: null,

    // Use shared escape function
    escapeHtml: escapeXml,

    formatTime(ts) {
        if (!ts) return '';
        const d = new Date(ts);
        if (Number.isNaN(d.getTime())) return '';
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    },

    isNameConflict(name, excludeIdx = -1) {
        const rawNames = App.raw.map(t => t.name);
        const viewNames = Store.state.globalViews.filter((_, i) => i !== excludeIdx).map(v => v.view);
        return rawNames.includes(name) || viewNames.includes(name);
    },

    makeUniqueName(base, excludeIdx = -1) {
        let name = base || 'View';
        let i = 1;
        while (this.isNameConflict(name, excludeIdx)) {
            name = `${base || 'View'}_${i++}`;
        }
        return name;
    },
    
    // Fixed: Ensure only Views are listed
    modManageViews() {
        const vs = Store.state.globalViews;
        const getFieldCount = (select) => (select || '').split(',').filter(Boolean).length;
        const joinTypeLabel = { 'inner': 'Inner Join', 'left': 'Left Join' };

        const renderList = (filterText = '') => {
            const filtered = vs.map((v, i) => ({ ...v, originalIndex: i }))
                .filter(v => {
                    if (!filterText) return true;
                    const searchLower = filterText.toLowerCase();
                    return v.view.toLowerCase().includes(searchLower) ||
                           v.left.toLowerCase().includes(searchLower) ||
                           v.right.toLowerCase().includes(searchLower) ||
                           (v.on || '').toLowerCase().includes(searchLower);
                });

            if (filtered.length === 0) {
                return filterText
                    ? '<div style="padding:20px; color:#999; text-align:center;">无匹配视图</div>'
                    : '<div style="padding:20px; color:#999; text-align:center;">暂无视图</div>';
            }

            return filtered.map((v, idx) => {
                const i = v.originalIndex;
                const stamp = this.formatTime(v.updatedAt || v.createdAt);
                const fieldCount = getFieldCount(v.select);
                const joinLabel = joinTypeLabel[v.type] || 'Inner Join';
                const meta = stamp
                    ? `${joinLabel} · ${v.left} | ${v.right} · ${fieldCount}列 · ${stamp}`
                    : `${joinLabel} · ${v.left} | ${v.right} · ${fieldCount}列`;
                const esc = this.escapeHtml;

                return `
                <div class="view-item" data-index="${i}" style="display:flex; justify-content:space-between; align-items:center; padding:10px; border:1px solid var(--border-light); margin-bottom:8px; border-radius:6px; background:var(--bg-card);">
                    <div style="display:flex; align-items:center; gap:8px; flex:1; min-width:0;">
                        <input type="checkbox" class="view-checkbox" data-index="${i}" style="flex-shrink:0;">
                        <div style="min-width:0; flex:1;">
                            <div style="font-weight:600; color:var(--primary); margin-bottom:2px;">${esc(v.view)}</div>
                            <div style="font-size:11px; color:var(--text-secondary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${esc(meta)}</div>
                        </div>
                    </div>
                    <div class="flex gap-2" id="jeActions_${i}" style="flex-shrink:0;">
                        <button class="sm" id="jeEdit_${i}" title="编辑视图">✎</button>
                        <button class="sm" id="jeCopy_${i}" title="复制视图">❐</button>
                        <button class="sm" id="jeExport_${i}" title="导出视图">⬇</button>
                        <button class="sm danger" id="jeDel_${i}" title="删除视图">×</button>
                    </div>
                    <div class="flex gap-2" id="jeConfirm_${i}" style="display:none; align-items:center;">
                        <span style="font-size:12px; color:var(--text-secondary);">确认删除？</span>
                        <button class="sm" id="jeDelCancel_${i}">取消</button>
                        <button class="sm danger" id="jeDelOk_${i}">删除</button>
                    </div>
                </div>`;
            }).join('');
        };

        App.modal('管理全局视图', `
            <div style="margin-bottom:12px;">
                <input type="text" id="jeViewSearch" placeholder="🔍 搜索视图名称、表名或关联条件..." style="width:100%; padding:8px; border:1px solid var(--border); border-radius:6px; font-size:13px;">
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <label class="flex items-center gap-2" style="font-size:12px; cursor:pointer;">
                    <input type="checkbox" id="jeViewSelectAll" style="cursor:pointer;">
                    <span>全选</span>
                </label>
                <div class="flex gap-2">
                    <button class="sm" id="jeBatchExport" disabled>⬇ 批量导出</button>
                    <button class="sm danger" id="jeBatchDelete" disabled>× 批量删除</button>
                </div>
            </div>
            <div id="viewList" style="max-height:300px; overflow-y:auto; margin-bottom:12px;">
                ${renderList()}
            </div>
            <div style="margin-bottom:12px;">
                <label>粘贴配置 (JSON)</label>
                <textarea id="jePaste" style="height:90px;" placeholder="{
  \"view\": \"MyView\", \"left\": \"A\", \"right\": \"B\", \"on\": \"ID=ID\", \"select\": \"left.ID,right.Name\"
}"></textarea>
                <div class="flex gap-2" style="margin-top:8px;">
                    <button class="sm" id="jePasteBtn">导入</button>
                    <button class="primary w-full" id="jeAddNew">＋ 新增视图</button>
                </div>
            </div>
        `);

        // 搜索过滤功能
        const searchInput = $('jeViewSearch');
        if (searchInput) {
            searchInput.oninput = () => {
                const filterText = searchInput.value.trim();
                $('viewList').innerHTML = renderList(filterText);
                this.bindViewActions(vs);
                updateBatchButtons();
            };
        }

        // 全选/取消全选
        const selectAllCheckbox = $('jeViewSelectAll');
        if (selectAllCheckbox) {
            selectAllCheckbox.onchange = () => {
                const checkboxes = document.querySelectorAll('.view-checkbox');
                checkboxes.forEach(cb => {
                    cb.checked = selectAllCheckbox.checked;
                });
                updateBatchButtons();
            };
        }

        // 更新批量操作按钮状态
        const updateBatchButtons = () => {
            const selectedCount = document.querySelectorAll('.view-checkbox:checked').length;
            const batchDeleteBtn = $('jeBatchDelete');
            const batchExportBtn = $('jeBatchExport');
            if (batchDeleteBtn) batchDeleteBtn.disabled = selectedCount === 0;
            if (batchExportBtn) batchExportBtn.disabled = selectedCount === 0;
        };

        // 批量删除
        const batchDeleteBtn = $('jeBatchDelete');
        if (batchDeleteBtn) {
            batchDeleteBtn.onclick = () => {
                const selectedCheckboxes = document.querySelectorAll('.view-checkbox:checked');
                if (selectedCheckboxes.length === 0) return;
                const selectedIndices = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.index)).sort((a, b) => b - a);
                if (confirm(`确定删除选中的 ${selectedIndices.length} 个视图吗？`)) {
                    selectedIndices.forEach(idx => {
                        Store.state.globalViews.splice(idx, 1);
                    });
                    Store.save();
                    App.updSelects();
                    this.modManageViews();
                    App.run();
                    Toast.show(`已删除 ${selectedIndices.length} 个视图`);
                }
            };
        }

        // 批量导出
        const batchExportBtn = $('jeBatchExport');
        if (batchExportBtn) {
            batchExportBtn.onclick = () => {
                const selectedCheckboxes = document.querySelectorAll('.view-checkbox:checked');
                if (selectedCheckboxes.length === 0) return;
                const selectedViews = Array.from(selectedCheckboxes).map(cb => Store.state.globalViews[parseInt(cb.dataset.index)]);
                Exporter.toJson({ kind: 'join-views', views: selectedViews }, `join_views_${Date.now()}`);
                Toast.show(`已导出 ${selectedViews.length} 个视图`);
            };
        }

        // 绑定单个视图的操作按钮
        this.bindViewActions = (views) => {
            views.forEach((v, i) => {
                const editBtn = $(`jeEdit_${i}`);
                const copyBtn = $(`jeCopy_${i}`);
                const exportBtn = $(`jeExport_${i}`);
                const delBtn = $(`jeDel_${i}`);
                const delCancelBtn = $(`jeDelCancel_${i}`);
                const delOkBtn = $(`jeDelOk_${i}`);
                const checkbox = document.querySelector(`.view-checkbox[data-index="${i}"]`);

                if (editBtn) editBtn.onclick = () => { $('modalOverlay').classList.add('hidden'); this.open(i, true); };
                if (copyBtn) copyBtn.onclick = () => {
                    const name = this.makeUniqueName(`${v.view}_copy`);
                    const nv = { ...v, view: name, createdAt: Date.now(), updatedAt: Date.now() };
                    Store.state.globalViews.push(nv);
                    Store.save();
                    App.updSelects();
                    this.modManageViews();
                    Toast.show('已复制');
                };
                if (exportBtn) exportBtn.onclick = () => Exporter.toJson({ kind: 'join-view', view: v }, `join_${v.view}`);
                if (delBtn) delBtn.onclick = () => {
                    const actions = $(`jeActions_${i}`);
                    const confirmRow = $(`jeConfirm_${i}`);
                    if (actions) actions.style.display = 'none';
                    if (confirmRow) confirmRow.style.display = 'flex';
                };
                if (delCancelBtn) delCancelBtn.onclick = () => {
                    const actions = $(`jeActions_${i}`);
                    const confirmRow = $(`jeConfirm_${i}`);
                    if (actions) actions.style.display = 'flex';
                    if (confirmRow) confirmRow.style.display = 'none';
                };
                if (delOkBtn) delOkBtn.onclick = () => {
                    Store.state.globalViews.splice(i, 1);
                    Store.save();
                    App.updSelects();
                    this.modManageViews();
                    App.run();
                };

                // 复选框变化时更新批量按钮状态
                if (checkbox) {
                    checkbox.onchange = updateBatchButtons;
                }
            });
        };

        // 初始绑定
        this.bindViewActions(vs);

        // 其他按钮绑定
        $('jeAddNew').onclick = () => { $('modalOverlay').classList.add('hidden'); this.open(-1, true); };
        const pasteBtn = $('jePasteBtn');
        if (pasteBtn) pasteBtn.onclick = () => this.importViewsFromText($('jePaste').value || '');
    },

    normalizeView(v) {
        if(!v || !v.view || !v.left || !v.right) return null;
        return {
            view: v.view,
            left: v.left,
            right: v.right,
            type: v.type || 'inner',
            on: v.on || '',
            select: v.select || '',
            createdAt: v.createdAt || Date.now(),
            updatedAt: Date.now()
        };
    },
    importViewsFromText(txt) {
        const raw = (txt || '').trim();
        if(!raw) return Toast.show('请输入配置内容', true);
        let data;
        try { data = JSON.parse(raw); } catch(e) { return alert('格式错误'); }
        let views = [];
        if(Array.isArray(data)) views = data;
        else if(data.kind === 'join-view' && data.view) views = [data.view];
        else if(data.globalViews) views = data.globalViews;
        else if(data.views) views = data.views;
        else if(data.view && data.left) views = [data];
        if(!views.length) return alert('未识别到视图配置');

        let imported = 0;
        views.forEach(v => {
            const nv = this.normalizeView(v);
            if(!nv) return;
            const idx = Store.state.globalViews.findIndex(x => x.view === nv.view);
            if(idx > -1) {
                if(confirm(`视图 ${nv.view} 已存在，是否覆盖？(取消则自动改名)`)) {
                    nv.createdAt = Store.state.globalViews[idx].createdAt || nv.createdAt;
                    Store.state.globalViews[idx] = nv;
                } else {
                    nv.view = this.makeUniqueName(nv.view);
                    Store.state.globalViews.push(nv);
                }
            } else {
                Store.state.globalViews.push(nv);
            }
            imported++;
        });
        if(imported) {
            Store.save(); App.updSelects(); App.run(); this.modManageViews();
            Toast.show(`已导入 ${imported} 个视图`);
        }
    },
    
    open(editIdx = -1, fromManageViews = false) {
        const p = $('joinModal'); p.classList.remove('hidden');
        document.body.classList.add('modal-open');
        this.state.editIdx = editIdx;
        this.state.fromManageViews = fromManageViews;
        this.metaCache = {};
        const v = editIdx > -1 ? Store.state.globalViews[editIdx] : { view:'', left:'', right:'', type:'inner', on:'', select:'' };

        this.state.titleBase = editIdx > -1 ? '编辑全局视图' : '新增全局视图';
        $('jeTitle').textContent = this.state.titleBase;
        $('jeName').value = v.view;
        $('jeType').value = v.type;

        const opts = App.getAvailableTables().map(n => `<option value="${n}">${n}</option>`).join('');
        $('jeLeftTable').innerHTML = opts;
        $('jeRightTable').innerHTML = opts;

        if (v.left) $('jeLeftTable').value = v.left;
        else if ($('jeLeftTable').options.length > 0) $('jeLeftTable').selectedIndex = 0;

        if (v.right) $('jeRightTable').value = v.right;
        else if ($('jeRightTable').options.length > 0) $('jeRightTable').selectedIndex = 0;

        this.state.rels = v.on ? v.on.split(',').map(s => { const p=s.split('='); return {l:p[0].trim(), r:p[1].trim()}; }) : [];
        if(this.state.rels.length === 0) this.state.rels.push({l:'', r:''});

        this.state.lSel = []; this.state.rSel = []; this.state.order = [];
        if(v.select) {
            const tokens = Joiner.buildSelectTokens(v.select);
            tokens.forEach(t => {
                const side = (t.side === 'right' || t.side === 'r') ? 'r' : 'l';
                if(side === 'l') this.state.lSel.push(t.col);
                else this.state.rSel.push(t.col);
                this.state.order.push({ side, col: t.col, alias: t.alias || '' });
            });
        }

        this.state.lOnlySel = false;
        this.state.rOnlySel = false;
        this.state.showL = true;
        this.state.showR = true;
        if($('jeLOnlySel')) $('jeLOnlySel').checked = false;
        if($('jeROnlySel')) $('jeROnlySel').checked = false;
        if($('jeOrderShowL')) $('jeOrderShowL').checked = true;
        if($('jeOrderShowR')) $('jeOrderShowR').checked = true;

        this.state.prevLeft = $('jeLeftTable').value;
        this.state.prevRight = $('jeRightTable').value;

        this.refreshColumns();
        this.renderRels();
        this.renderSelectedOrder();
        this.updateAll();
        this.setDirty(false);
    },

    close(force=false) {
        if(!force && this.state.dirty) {
            if(!confirm('有未保存修改，确定关闭？')) return;
        }
        $('joinModal').classList.add('hidden');
        document.body.classList.remove('modal-open');
    },

    setDirty(flag) {
        this.state.dirty = flag;
        const title = this.state.titleBase || '全局视图';
        $('jeTitle').textContent = flag ? `${title} *` : title;
    },
    markDirty() { this.setDirty(true); },
    
    refreshColumns() {
        const lName = $('jeLeftTable').value;
        const rName = $('jeRightTable').value;
        const lCols = App.getCols(lName);
        const rCols = App.getCols(rName);

        this.state.lSel = this.state.lSel.filter(c => lCols.includes(c));
        this.state.rSel = this.state.rSel.filter(c => rCols.includes(c));
        this.state.rels.forEach(r => {
            if(r.l && !lCols.includes(r.l)) r.l = '';
            if(r.r && !rCols.includes(r.r)) r.r = '';
        });
        this.syncOrderFromSelections(lCols, rCols);

        this.renderColList('jeLList', lCols, this.state.lSel, 'l');
        this.renderColList('jeRList', rCols, this.state.rSel, 'r');
        this.renderSelectedOrder();
        this.renderRels();
        this.updateRelMeta();
        this.updateAll();
    },
    
    getFilteredCols(side, cols) {
        const search = $(side === 'l' ? 'jeLSearch' : 'jeRSearch').value.toLowerCase();
        const onlySelected = side === 'l' ? this.state.lOnlySel : this.state.rOnlySel;
        const selected = side === 'l' ? this.state.lSel : this.state.rSel;
        let list = (cols || []).slice();
        if(onlySelected) list = list.filter(c => selected.includes(c));
        if(search) list = list.filter(c => c.toLowerCase().includes(search));
        return list;
    },
    renderColList(id, cols, selected, side) {
        const list = this.getFilteredCols(side, cols);
        const esc = this.escapeHtml;
        const html = list.map(c => `
            <label class="checkbox-row">
                <input type="checkbox" data-side="${side}" value="${esc(c)}" ${selected.includes(c)?'checked':''}>
                <span>${esc(c)}</span>
            </label>
        `).join('');
        $(id).innerHTML = html || '<div style="padding:8px; color:#999;">无匹配字段</div>';

        $(id).querySelectorAll('input').forEach(chk => {
            chk.onchange = () => this.setSelection(side, chk.value, chk.checked);
        });
    },

    renderRels() {
        const lName = $('jeLeftTable').value;
        const rName = $('jeRightTable').value;
        const lCols = App.getCols(lName);
        const rCols = App.getCols(rName);
        const esc = this.escapeHtml;
        const lOpts = lCols.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join('');
        const rOpts = rCols.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join('');

        $('jeRelContainer').innerHTML = this.state.rels.map((r, i) => `
            <div class="join-rel-card" data-idx="${i}">
                <div class="je-row">
                    <select class="je-rel-l" data-idx="${i}">${lOpts || '<option>无字段</option>'}</select>
                    <span style="opacity:0.6;">=</span>
                    <select class="je-rel-r" data-idx="${i}">${rOpts || '<option>无字段</option>'}</select>
                    <button class="icon-btn sm" data-swap="${i}" title="交换左右">⇄</button>
                    <button class="icon-btn sm danger" data-del="${i}" title="删除">×</button>
                </div>
                <div class="rel-meta-row">
                    <span class="rel-meta" id="jeRelMetaL_${i}"></span>
                    <span class="rel-meta" id="jeRelMetaR_${i}"></span>
                </div>
            </div>
        `).join('');

        const ls = document.querySelectorAll('.je-rel-l');
        const rs = document.querySelectorAll('.je-rel-r');
        this.state.rels.forEach((r, i) => {
            if(r.l && lCols.includes(r.l)) ls[i].value = r.l; else r.l = '';
            if(r.r && rCols.includes(r.r)) rs[i].value = r.r; else r.r = '';
        });

        ls.forEach(s => s.onchange = e => {
            this.state.rels[e.target.dataset.idx].l = e.target.value;
            this.markDirty();
            this.updateRelMeta();
            this.updateAll();
        });
        rs.forEach(s => s.onchange = e => {
            this.state.rels[e.target.dataset.idx].r = e.target.value;
            this.markDirty();
            this.updateRelMeta();
            this.updateAll();
        });
        document.querySelectorAll('[data-swap]').forEach(btn => {
            btn.onclick = () => this.swapRel(+btn.dataset.swap);
        });
        document.querySelectorAll('[data-del]').forEach(btn => {
            btn.onclick = () => this.delRel(+btn.dataset.del);
        });
        this.updateRelMeta();
    },

    addRel() { this.state.rels.push({l:'', r:''}); this.markDirty(); this.renderRels(); this.updateAll(); },
    delRel(i) {
        this.state.rels.splice(i, 1);
        if(this.state.rels.length === 0) this.state.rels.push({l:'', r:''});
        this.markDirty();
        this.renderRels();
        this.updateAll();
    },
    swapRel(i) {
        const r = this.state.rels[i];
        if(!r) return;
        const tmp = r.l; r.l = r.r; r.r = tmp;
        this.markDirty();
        this.renderRels();
        this.updateAll();
    },
    autoMatchRels() {
        const lCols = App.getCols($('jeLeftTable').value);
        const rCols = App.getCols($('jeRightTable').value);
        const lSet = new Set(lCols);
        const common = rCols.filter(c => lSet.has(c));
        if(!common.length) return Toast.show('无同名字段可匹配', true);
        const hasExisting = this.state.rels.some(r => r.l || r.r);
        if(hasExisting && !confirm('将覆盖现有关联条件，继续？')) return;
        this.state.rels = common.map(c => ({ l: c, r: c }));
        this.markDirty();
        this.renderRels();
        this.updateAll();
    },
    
    buildOnString(rels) {
        return rels.map(r => `${r.l}=${r.r}`).join(',');
    },
    buildSelectString() {
        return this.state.order.map(o => {
            const side = o.side === 'r' ? 'right' : 'left';
            const base = `${side}.${o.col}`;
            const alias = (o.alias || '').trim();
            return alias ? `${base} as ${alias}` : base;
        }).join(',');
    },
    getCurrentConfig() {
        return {
            view: $('jeName').value.trim(),
            left: $('jeLeftTable').value,
            right: $('jeRightTable').value,
            type: $('jeType').value,
            on: this.buildOnString(this.state.rels.filter(r => r.l && r.r)),
            select: this.buildSelectString()
        };
    },

    validate() {
        const errors = [];
        const warnings = [];
        const name = $('jeName').value.trim();
        if(!name) errors.push('请填写视图名称');
        if(name && this.isNameConflict(name, this.state.editIdx)) errors.push('视图名称与已有表/视图冲突');
        if(!$('jeLeftTable').value || !$('jeRightTable').value) errors.push('请选择左右表');

        const rels = this.state.rels.filter(r => r.l || r.r);
        const invalidRels = rels.filter(r => !r.l || !r.r);
        const validRels = rels.filter(r => r.l && r.r);
        if(invalidRels.length) errors.push('关联条件存在空字段');
        if(validRels.length === 0) errors.push('至少配置一个关联条件');
        if(this.state.order.length === 0) errors.push('至少选择一个输出列');

        const headers = this.state.order.map(o => (o.alias || o.col || '').trim()).filter(Boolean);
        const dupes = headers.filter((h,i) => headers.indexOf(h) !== i);
        if(dupes.length) warnings.push(`输出列重名: ${Array.from(new Set(dupes)).join(', ')}`);

        return { ok: errors.length === 0, errors, warnings };
    },
    updateSaveState() {
        const { ok, errors, warnings } = this.validate();
        const warn = $('jeWarn');
        if(errors.length) {
            warn.textContent = `⚠ ${errors.join('；')}`;
            warn.className = 'join-warn error';
        } else if(warnings.length) {
            warn.textContent = `提示: ${warnings.join('；')}`;
            warn.className = 'join-warn';
        } else {
            warn.textContent = '可以保存';
            warn.className = 'join-warn ok';
        }
        ['jeSave', 'jeSaveFooter'].forEach(id => { if($(id)) $(id).disabled = !ok; });
    },
    updateStatus() {
        const total = this.state.lSel.length + this.state.rSel.length;
        $('jeStatus').textContent = `已选输出列: ${total} (Left: ${this.state.lSel.length}, Right: ${this.state.rSel.length})`;
    },
    updatePreview() {
        const cfg = this.getCurrentConfig();
        const hasRel = this.state.rels.some(r => r.l && r.r);
        const el = $('jePreview');
        if(!cfg.left || !cfg.right || !hasRel) { el.textContent = '预览: -'; return; }
        const stats = Joiner.stats(App.raw, cfg, Store.state.globalViews);
        if(!stats) { el.textContent = '预览: -'; return; }
        el.textContent = `预览: 输出 ${stats.outRows} · 匹配 ${stats.matched} · 左未匹配 ${stats.leftOnly} · 右未匹配 ${stats.rightOnly}`;
    },
    updateDependencyInfo() {
        const rName = $('jeRightTable').value;
        const el = $('jeDependency');
        const v = Store.state.globalViews.find(x => x.view === rName);
        if(!el) return;
        if(!v) { el.textContent = '右表为原始表'; return; }
        const chain = this.buildDependencyChain(rName);
        const stamp = this.formatTime(v.updatedAt || v.createdAt);
        el.innerHTML = `<div style="font-weight:700; margin-bottom:4px;">视图依赖</div><div>${this.escapeHtml(chain)}</div><div class="muted" style="margin-top:4px;">更新: ${stamp || '未知'}</div>`;
    },
    buildDependencyChain(name, seen = new Set()) {
        const v = Store.state.globalViews.find(x => x.view === name);
        if(!v) return name;
        if(seen.has(name)) return `${name}(循环)`;
        const next = new Set(seen); next.add(name);
        const left = this.buildDependencyChain(v.left, next);
        const right = this.buildDependencyChain(v.right, next);
        return `${name} -> (${left} + ${right})`;
    },

    getTableData(name) {
        const raw = App.raw.find(t => t.name === name);
        if(raw) return raw;
        const view = Store.state.globalViews.find(v => v.view === name);
        if(view) return Joiner.run(App.raw, view, Store.state.globalViews);
        return null;
    },
    inferType(val) {
        if(val === null || val === undefined) return '空';
        const s = String(val).trim();
        if(!s) return '空';
        if(/^[-+]?\d+(\.\d+)?$/.test(s)) return '数值';
        if(/^\d{4}[-/]\d{1,2}[-/]\d{1,2}/.test(s)) return '日期';
        if(!Number.isNaN(Date.parse(s)) && /[-/]/.test(s)) return '日期';
        return '文本';
    },
    getColMeta(tableName, col) {
        if(!tableName || !col) return { type: '-', sample: '-' };
        const key = `${tableName}::${col}`;
        if(this.metaCache[key]) return this.metaCache[key];
        const table = this.getTableData(tableName);
        if(!table) return { type: '-', sample: '-' };
        const idx = table.headers.indexOf(col);
        if(idx === -1) return { type: '-', sample: '-' };
        let sample = '';
        for(const row of table.rows) {
            const v = row[idx];
            if(v !== undefined && v !== null && String(v).trim() !== '') { sample = v; break; }
        }
        const type = this.inferType(sample);
        const sText = sample === '' ? '-' : String(sample);
        const short = sText.length > 20 ? `${sText.slice(0, 20)}…` : sText;
        const res = { type, sample: short };
        this.metaCache[key] = res;
        return res;
    },
    updateRelMeta() {
        const lName = $('jeLeftTable').value;
        const rName = $('jeRightTable').value;
        this.state.rels.forEach((r, i) => {
            const l = this.getColMeta(lName, r.l);
            const rmeta = this.getColMeta(rName, r.r);
            const lEl = $(`jeRelMetaL_${i}`);
            const rEl = $(`jeRelMetaR_${i}`);
            if(lEl) lEl.textContent = `左: ${l.type} · 例 ${l.sample}`;
            if(rEl) rEl.textContent = `右: ${rmeta.type} · 例 ${rmeta.sample}`;
        });
    },

    handleTableChange(side) {
        const sel = side === 'l' ? $('jeLeftTable') : $('jeRightTable');
        const next = sel.value;
        const prev = side === 'l' ? this.state.prevLeft : this.state.prevRight;
        if(next === prev) return;
        const cols = App.getCols(next);
        const removedCols = (side === 'l' ? this.state.lSel : this.state.rSel).filter(c => !cols.includes(c));
        const removedRels = this.state.rels.filter(r => {
            const col = side === 'l' ? r.l : r.r;
            return col && !cols.includes(col);
        }).map(r => `${r.l || '?'}=${r.r || '?'}`);

        const applyChange = () => {
            if(side === 'l') this.state.prevLeft = next; else this.state.prevRight = next;
            this.refreshColumns();
            this.markDirty();
        };
        const cancelChange = () => { sel.value = prev; };

        if(removedCols.length || removedRels.length) {
            this.confirmTableChange({
                title: '切换表确认',
                removedCols,
                removedRels,
                onConfirm: applyChange,
                onCancel: cancelChange
            });
            return;
        }
        applyChange();
    },
    confirmTableChange({ title, removedCols, removedRels, onConfirm, onCancel }) {
        const esc = this.escapeHtml;
        const colHtml = removedCols.length ? `<div class="muted">将移除列</div><div style="display:flex; flex-wrap:wrap; gap:6px; margin:6px 0;">${removedCols.map(c => `<span class="chip">${esc(c)}</span>`).join('')}</div>` : '';
        const relHtml = removedRels.length ? `<div class="muted" style="margin-top:6px;">失效关联</div><div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:6px;">${removedRels.map(c => `<span class="chip">${esc(c)}</span>`).join('')}</div>` : '';
        App.modal(title, `${colHtml}${relHtml}<div style="text-align:right; margin-top:12px;"><button class="sm" id="jeTblCancel">取消</button><button class="primary sm" id="jeTblOk" style="margin-left:8px;">继续</button></div>`);
        $('jeTblCancel').onclick = () => { $('modalOverlay').classList.add('hidden'); if(onCancel) onCancel(); };
        $('jeTblOk').onclick = () => { $('modalOverlay').classList.add('hidden'); if(onConfirm) onConfirm(); };
    },

    toggleAll(side) {
        const cols = this.getFilteredCols(side, App.getCols(side === 'l' ? $('jeLeftTable').value : $('jeRightTable').value));
        if(!cols.length) return;
        const selected = side === 'l' ? this.state.lSel : this.state.rSel;
        const allChecked = cols.every(c => selected.includes(c));
        cols.forEach(c => this.setSelection(side, c, !allChecked, false));
        this.syncOrderFromSelections(App.getCols($('jeLeftTable').value), App.getCols($('jeRightTable').value));
        this.renderColList(side === 'l' ? 'jeLList' : 'jeRList', App.getCols(side === 'l' ? $('jeLeftTable').value : $('jeRightTable').value), selected, side);
        this.renderSelectedOrder();
        this.updateAll();
        this.markDirty();
    },
    selectFiltered(side) {
        const cols = this.getFilteredCols(side, App.getCols(side === 'l' ? $('jeLeftTable').value : $('jeRightTable').value));
        if(!cols.length) return;
        cols.forEach(c => this.setSelection(side, c, true, false));
        this.syncOrderFromSelections(App.getCols($('jeLeftTable').value), App.getCols($('jeRightTable').value));
        this.renderColList(side === 'l' ? 'jeLList' : 'jeRList', App.getCols(side === 'l' ? $('jeLeftTable').value : $('jeRightTable').value), side === 'l' ? this.state.lSel : this.state.rSel, side);
        this.renderSelectedOrder();
        this.updateAll();
        this.markDirty();
    },

    setSelection(side, col, checked, appendToEnd=true) {
        const arr = side === 'l' ? this.state.lSel : this.state.rSel;
        const idx = arr.indexOf(col);
        if(checked) {
            if(idx === -1) arr.push(col);
        } else {
            if(idx > -1) arr.splice(idx,1);
        }
        this.syncOrderFromSelections(App.getCols($('jeLeftTable').value), App.getCols($('jeRightTable').value), appendToEnd ? {side, col, checked} : null);
        this.renderSelectedOrder();
        this.updateAll();
        this.markDirty();
    },

    syncOrderFromSelections(lCols, rCols, lastChange=null) {
        this.state.order = this.state.order.filter(o => {
            const list = o.side === 'l' ? this.state.lSel : this.state.rSel;
            return list.includes(o.col);
        });
        const seen = new Set(this.state.order.map(o => `${o.side}:${o.col}`));

        if(lastChange && lastChange.checked) {
            const key = `${lastChange.side}:${lastChange.col}`;
            if(!seen.has(key)) {
                this.state.order.push({ side:lastChange.side, col:lastChange.col, alias:'' });
                seen.add(key);
            }
        }

        const appendMissing = (side, arr, cols=[]) => {
            arr.forEach(c => {
                const key = `${side}:${c}`;
                if(!seen.has(key) && (!cols.length || cols.includes(c))) {
                    this.state.order.push({ side, col:c, alias:'' });
                    seen.add(key);
                }
            });
        };
        appendMissing('l', this.state.lSel, lCols || []);
        appendMissing('r', this.state.rSel, rCols || []);
    },

    renderSelectedOrder() {
        const box = $('jeOrderList'); if(!box) return;
        const visible = this.state.order.filter(o => (o.side === 'l' ? this.state.showL : this.state.showR));
        if(!visible.length) {
            box.innerHTML = '<div style="font-size:11px; color:var(--text-tertiary);">未选择输出列</div>';
            return;
        }
        const leftSel = $('jeLeftTable');
        const rightSel = $('jeRightTable');
        const leftName = (leftSel && leftSel.value) ? leftSel.value : '左表';
        const rightName = (rightSel && rightSel.value) ? rightSel.value : '右表';
        const esc = this.escapeHtml;
        box.innerHTML = visible.map(o => {
            const idx = this.state.order.indexOf(o);
            const tableName = o.side === 'l' ? leftName : rightName;
            const labelRaw = `${tableName}.${o.col}`;
            const label = esc(labelRaw);
            const alias = esc(o.alias || '');
            return `
            <div class="join-chip" data-idx="${idx}" draggable="true">
                <div class="join-chip-main">
                    <span class="join-chip-label" title="${label}">${label}</span>
                    <input class="join-alias" data-idx="${idx}" placeholder="别名" value="${alias}">
                </div>
                <div class="join-chip-actions">
                    <button class="icon-btn sm" data-move="-1" title="上移" style="width:22px; height:22px;">↑</button>
                    <button class="icon-btn sm" data-move="1" title="下移" style="width:22px; height:22px;">↓</button>
                    <button class="icon-btn sm danger" data-remove="1" title="移除" style="width:22px; height:22px;">×</button>
                </div>
            </div>`;
        }).join('');

        box.querySelectorAll('button[data-move]').forEach(btn => {
            btn.onclick = () => {
                const idx = +btn.closest('[data-idx]').dataset.idx;
                this.moveOrder(idx, +btn.dataset.move);
            };
        });
        box.querySelectorAll('button[data-remove]').forEach(btn => {
            btn.onclick = () => {
                const idx = +btn.closest('[data-idx]').dataset.idx;
                this.removeOrder(idx);
            };
        });
        box.querySelectorAll('.join-alias').forEach(inp => {
            inp.oninput = () => {
                const idx = +inp.dataset.idx;
                this.state.order[idx].alias = inp.value.trim();
                this.markDirty();
                this.updateAll();
            };
        });

        box.querySelectorAll('.join-chip').forEach(chip => {
            chip.addEventListener('dragstart', e => {
                this.dragIdx = +chip.dataset.idx;
                chip.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });
            chip.addEventListener('dragend', () => {
                chip.classList.remove('dragging');
                this.dragIdx = null;
            });
            chip.addEventListener('dragover', e => e.preventDefault());
            chip.addEventListener('drop', e => {
                e.preventDefault();
                const to = +chip.dataset.idx;
                if(this.dragIdx === null || this.dragIdx === to) return;
                this.moveOrderTo(this.dragIdx, to);
            });
        });
    },

    moveOrder(idx, delta) {
        const target = idx + delta;
        if(target < 0 || target >= this.state.order.length) return;
        const [item] = this.state.order.splice(idx, 1);
        this.state.order.splice(target, 0, item);
        this.renderSelectedOrder();
        this.updateAll();
        this.markDirty();
    },
    moveOrderTo(from, to) {
        if(from < 0 || to < 0 || from === to) return;
        const [item] = this.state.order.splice(from, 1);
        this.state.order.splice(to, 0, item);
        this.renderSelectedOrder();
        this.updateAll();
        this.markDirty();
    },
    removeOrder(idx) {
        const item = this.state.order[idx];
        if(!item) return;
        this.state.order.splice(idx, 1);
        const arr = item.side === 'l' ? this.state.lSel : this.state.rSel;
        const sIdx = arr.indexOf(item.col);
        if(sIdx > -1) arr.splice(sIdx, 1);
        this.renderColList('jeLList', App.getCols($('jeLeftTable').value), this.state.lSel, 'l');
        this.renderColList('jeRList', App.getCols($('jeRightTable').value), this.state.rSel, 'r');
        this.renderSelectedOrder();
        this.updateAll();
        this.markDirty();
    },
    rebuildOrder() {
        const aliasMap = new Map(this.state.order.map(o => [`${o.side}:${o.col}`, o.alias]));
        this.state.order = [];
        this.state.lSel.forEach(c => this.state.order.push({ side:'l', col:c, alias: aliasMap.get(`l:${c}`) || '' }));
        this.state.rSel.forEach(c => this.state.order.push({ side:'r', col:c, alias: aliasMap.get(`r:${c}`) || '' }));
        this.renderSelectedOrder();
        this.updateAll();
        this.markDirty();
    },
    clearOrder() {
        this.state.lSel = [];
        this.state.rSel = [];
        this.state.order = [];
        this.renderColList('jeLList', App.getCols($('jeLeftTable').value), this.state.lSel, 'l');
        this.renderColList('jeRList', App.getCols($('jeRightTable').value), this.state.rSel, 'r');
        this.renderSelectedOrder();
        this.updateAll();
        this.markDirty();
    },
    keepOnly(side) {
        if(side === 'l') this.state.rSel = [];
        if(side === 'r') this.state.lSel = [];
        this.state.order = this.state.order.filter(o => o.side === side);
        this.renderColList('jeLList', App.getCols($('jeLeftTable').value), this.state.lSel, 'l');
        this.renderColList('jeRList', App.getCols($('jeRightTable').value), this.state.rSel, 'r');
        this.renderSelectedOrder();
        this.updateAll();
        this.markDirty();
    },

    updateAll() {
        this.updateStatus();
        this.updateSaveState();
        this.updatePreview();
        this.updateDependencyInfo();
    },
    
    save() {
        document.querySelectorAll('.je-rel-l').forEach((s,i) => this.state.rels[i].l = s.value);
        document.querySelectorAll('.je-rel-r').forEach((s,i) => this.state.rels[i].r = s.value);

        const check = this.validate();
        if(!check.ok) return alert(check.errors.join('；'));

        const name = $('jeName').value.trim();
        const onStr = this.buildOnString(this.state.rels.filter(r => r.l && r.r));
        const selStr = this.buildSelectString();

        const base = this.state.editIdx > -1 ? Store.state.globalViews[this.state.editIdx] : {};
        const nv = {
            view: name,
            left: $('jeLeftTable').value,
            right: $('jeRightTable').value,
            type: $('jeType').value,
            on: onStr,
            select: selStr,
            createdAt: base.createdAt || Date.now(),
            updatedAt: Date.now()
        };

        if(this.state.editIdx > -1) Store.state.globalViews[this.state.editIdx] = nv;
        else Store.state.globalViews.push(nv);

        Store.save();
        App.updSelects();
        App.run();
        this.setDirty(false);
        $('joinModal').classList.add('hidden');
        document.body.classList.remove('modal-open');

        // 如果从管理视图进入，重新打开管理视图
        if (this.state.fromManageViews) {
            this.modManageViews();
        }
    }
};

/* Selection Logic */
const Select = {
    start: null, end: null, active: false,
    init() {
        const p = $('previewArea');
        p.addEventListener('mousedown', e => {
            const td = e.target.closest('td'); if(!td) { this.clear(); return; }
            this.active = true; this.start = this.end = this.getCoord(td); this.draw();
        });
        p.addEventListener('mouseover', e => {
            if(!this.active) return;
            const td = e.target.closest('td');
            if(td && this.getCoord(td).idx === this.start.idx) { this.end = this.getCoord(td); this.draw(); }
        });
        document.addEventListener('mouseup', () => this.active=false);
        document.addEventListener('copy', e => { if(this.start && this.end) { e.preventDefault(); this.copy(e); } });
    },
    getCoord(td) { return { idx: +td.closest('table').dataset.idx, r: +td.dataset.r, c: +td.dataset.c }; },
    draw() {
        document.querySelectorAll('.selected-cell').forEach(e=>e.classList.remove('selected-cell'));
        if(!this.start) return;
        const tbl = document.querySelector(`table[data-idx="${this.start.idx}"]`); if(!tbl) return;
        const minR=Math.min(this.start.r,this.end.r), maxR=Math.max(this.start.r,this.end.r);
        const minC=Math.min(this.start.c,this.end.c), maxC=Math.max(this.start.c,this.end.c);
        for(let r=minR; r<=maxR; r++) { for(let c=minC; c<=maxC; c++) { const td = tbl.querySelector(`td[data-r="${r}"][data-c="${c}"]`); if(td) td.classList.add('selected-cell'); } }
    },
    clear() { this.start=null; this.end=null; this.draw(); },
    copy(e) {
        const tbl = document.querySelector(`table[data-idx="${this.start.idx}"]`);
        const minR=Math.min(this.start.r,this.end.r), maxR=Math.max(this.start.r,this.end.r);
        const minC=Math.min(this.start.c,this.end.c), maxC=Math.max(this.start.c,this.end.c);
        let hHtml = '<thead><tr>'; let hText = '';
        const thead = tbl.querySelector('thead');
        if(thead) {
            const ths = thead.querySelectorAll('th');
            for(let c=minC; c<=maxC; c++) {
               const txt = ths[c] ? ths[c].textContent : '';
               hHtml += `<th style="background:#444; color:#fff; border:1px solid #ccc;">${txt}</th>`; hText += txt + '\t';
            }
        }
        hHtml += '</tr></thead>'; hText = hText.trimEnd() + '\n';
        let bHtml = '<tbody>'; let bText = '';
        for(let r=minR; r<=maxR; r++) {
            bHtml += '<tr>';
            for(let c=minC; c<=maxC; c++) {
                const td = tbl.querySelector(`td[data-r="${r}"][data-c="${c}"]`);
                const v = td?td.textContent:''; bHtml += `<td style="border:1px solid #ccc;">${v}</td>`; bText += v + '\t';
            }
            bHtml += '</tr>'; bText = bText.trimEnd() + '\n';
        }
        bHtml += '</tbody>';
        e.clipboardData.setData('text/html', `<table border="1">${hHtml}${bHtml}</table>`);
        e.clipboardData.setData('text/plain', hText + bText);
        Toast.show(`已复制 ${maxR-minR+1} 行`);
    }
};

/* Main App */
const App = {
    raw: [], rendered: [],
    filterPopover: { open:false, table:null, col:null },
    activeEditor: null,
    init() {
        Store.init(); Select.init(); this.bind(); this.renderTabs(); this.loadDoc();
        this.bindSidebar(); this.bindAccordions();
        this.initInputResizer();

        // Picker Logic
        $('previewArea').addEventListener('click', e => {
            if(!document.body.classList.contains('picker-active')) return;
            const th = e.target.closest('th');
            if(th && JoinEditor.lastFocusedInput) {
                // ... logic for picker ...
            }
        });
    },

    initInputResizer() {
        const resizer = $('inputResizer');
        const rawInput = $('rawInput');
        if(!resizer || !rawInput) return;

        // Restore saved height
        const savedHeight = localStorage.getItem('v16_4_inputHeight');
        if(savedHeight) {
            const h = parseInt(savedHeight, 10);
            if(h >= 120 && h <= 600) {
                rawInput.style.height = h + 'px';
            }
        }

        let isDragging = false;
        let startY = 0;
        let startHeight = 0;

        const onMouseDown = (e) => {
            isDragging = true;
            startY = e.clientY;
            startHeight = rawInput.offsetHeight;
            resizer.classList.add('dragging');
            document.body.style.cursor = 'ns-resize';
            document.body.style.userSelect = 'none';
            e.preventDefault();
        };

        const onMouseMove = (e) => {
            if(!isDragging) return;
            const delta = e.clientY - startY;
            let newHeight = startHeight + delta;

            // Constrain height
            if(newHeight < 120) newHeight = 120;
            if(newHeight > 600) newHeight = 600;

            rawInput.style.height = newHeight + 'px';
        };

        const onMouseUp = () => {
            if(isDragging) {
                isDragging = false;
                resizer.classList.remove('dragging');
                document.body.style.cursor = '';
                document.body.style.userSelect = '';

                // Save height to localStorage
                localStorage.setItem('v16_4_inputHeight', rawInput.style.height);
            }
        };

        resizer.addEventListener('mousedown', onMouseDown);
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);

        // Touch support for mobile
        resizer.addEventListener('touchstart', (e) => {
            const touch = e.touches[0];
            onMouseDown({ clientY: touch.clientY, preventDefault: () => e.preventDefault() });
        }, { passive: false });

        document.addEventListener('touchmove', (e) => {
            if(!isDragging) return;
            const touch = e.touches[0];
            onMouseMove({ clientY: touch.clientY });
        }, { passive: false });

        document.addEventListener('touchend', onMouseUp);
    },
    
    getAvailableTables() {
        const raws = this.raw.map(t => t.name);
        const views = Store.state.globalViews.map(v => v.view);
        return [...raws, ...views];
    },
    
    getCols(tableName) {
        if(!tableName) return [];
        const raw = this.raw.find(t => t.name === tableName);
        if(raw) return raw.headers;
        const view = Store.state.globalViews.find(v => v.view === tableName);
        if(view) {
            const res = Joiner.run(this.raw, view, Store.state.globalViews);
            return res ? res.headers : [];
        }
        return [];
    },

    bindSidebar() {
        const sidebar = $('sidebar');
        const toggle = $('sidebarToggle');
        if(toggle) toggle.onclick = () => { sidebar.classList.toggle('collapsed'); };
        const hint = sidebar ? sidebar.querySelector('.collapse-hint') : null;
        if(hint) hint.onclick = () => sidebar.classList.remove('collapsed');

        const tabBtns = document.querySelectorAll('[data-tab-btn]');
        const panes = document.querySelectorAll('.sidebar-pane');
        const setTab = (t) => {
            tabBtns.forEach(b => b.classList.toggle('active', b.dataset.tabBtn===t));
            panes.forEach(p => p.classList.toggle('active', p.dataset.tab===t));
        };
        tabBtns.forEach(btn => btn.onclick = () => setTab(btn.dataset.tabBtn));
        setTab('data');
    },

    bindAccordions() {
        document.querySelectorAll('.acc-head').forEach(head => {
            head.onclick = () => {
                const item = head.parentElement;
                item.classList.toggle('open');
            };
        });
    },

    bind() {
        $('addTabBtn').onclick = () => { Store.addDoc(); this.renderTabs(); this.loadDoc(); };
        const doParse = () => this.run();
        const doClear = () => { $('rawInput').value=''; this.run(); };
        $('parseBtn').onclick = doParse;
        $('clearBtn').onclick = doClear;
        
        const loadSample = () => {
            $('rawInput').value = `table-data Inventory
validflag ID      Product       Category    Stock   Price
 1        1001    Widget_A      Hardware    50      10.50
 1        1002    Widget_B      Hardware    0       25.00
 1        1003    Gadget_X      Electronics 15      99.99
 1        1004    Gadget_Y      Electronics 5       150.00

table-data Orders
validflag OrderID CustID  ProdID  Qty   Status
 1        5001    C001    1001    5     Shipped
 1        5002    C002    1003    1     Pending
 1        5003    C001    1002    2     Backorder
 1        5004    C003    1001    10    Shipped

table-data SystemLogs
validflag Time      Level   Message                 Code
 1        10:00:01  INFO    System started          0x00
 1        10:05:23  WARN    High memory usage       0x04
 1        10:15:00  ERROR   Connection timeout      0x99
 1        10:15:01  INFO    Retry connection...     0x00`;
            this.run();
        };
        const sampleBtn = $('sampleBtn'); if(sampleBtn) sampleBtn.onclick = loadSample;
        const sampleLink = $('sampleLink'); if(sampleLink) sampleLink.onclick = loadSample;

        $('rawInput').oninput = e => { Store.curr().raw = e.target.value; Store.save(); };
        $('tabsContainer').onclick = e => {
            if(e.target.classList.contains('doc-tab-close')) {
                e.stopPropagation();
                const t = e.target.closest('.doc-tab');
                Store.removeDoc(t.dataset.id); 
                App.renderTabs(); App.loadDoc();
                return;
            }
            const t = e.target.closest('.doc-tab'); if(!t) return;
            Store.state.activeId = t.dataset.id; Store.save(); this.renderTabs(); this.loadDoc();
        };

        const inputBind = (id, k, subK) => $(id).oninput = e => {
            const val = e.target.type==='checkbox'?e.target.checked:e.target.value;
            if(subK) { if(k==='rules') { const tbl=$('targetTableSelect').value; if(tbl) Store.updateRule(tbl, subK, val); } else Store.updateUI(k, val); } else Store.updateUI(k, val);
            this.renderPreview();
        };
        inputBind('globalFilter', 'globalFilter');
        inputBind('checkHl', 'enableHighlight');
        inputBind('checkOnlyHl', 'onlyHighlighted');
        inputBind('checkExpSelected', 'exportOnlyChecked');
        inputBind('expColSelect', 'exportCols');

        $('targetTableSelect').onchange = () => this.syncRules();
        inputBind('hlInput', 'rules', 'hl');
        inputBind('filterInput', 'rules', 'filter');
        $('focusColsInput').onchange = e => {
            const t = $('targetTableSelect').value;
            if(t) Store.updateRule(t, 'focus', e.target.value.split(',').filter(s=>s.trim()));
            this.renderPreview();
        };

        $('tablesTrigger').onclick = () => this.modTables();
        $('viewsTrigger').onclick = () => this.modViews();
        // FIX: Correctly call JoinEditor.modManageViews
        $('manageViewsBtn').onclick = e => { e.stopPropagation(); JoinEditor.modManageViews(); };
        $('selectColsBtn').onclick = () => this.modCols();
        $('themeBtn').onclick = () => Store.toggleTheme();

        $('exportRawBtn').onclick = () => Exporter.toExcel(this.raw, 'raw');
        $('exportPrevBtn').onclick = () => {
            const data = this.rendered.map(r => ({
                name: r.name || 'Sheet',
                headers: r.headers,
                rows: r.rows.map(row => row.d)
            }));
            Exporter.toExcel(data, 'preview');
        };
        $('exportTabBtn').onclick = () => Exporter.toJson({ kind:'table-tool-tabs', docs: Store.state.docs }, 'tabs');
        $('importTabBtn').onclick = () => $('fileInputTab').click();
        $('fileInputTab').onchange = e => {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = evt => {
                try {
                    const d = JSON.parse(evt.target.result);
                    if(d.kind !== 'table-tool-tabs') throw new Error();
                    if(confirm('覆盖现有? (取消则追加)')) Store.state.docs = d.docs;
                    else Store.state.docs = Store.state.docs.concat(d.docs);
                    Store.save(); App.renderTabs(); App.loadDoc(); Toast.show('导入成功');
                } catch(e){ alert('格式错误'); }
                e.target.value = '';
            };
            r.readAsText(f);
        };
        $('exportConfigBtn').onclick = () => Exporter.toJson({ kind:'table-tool-config', globalViews: Store.state.globalViews, docs: Store.state.docs.map(d=>({id:d.id, title:d.title, ui:d.ui})) }, 'config');
        $('importConfigBtn').onclick = () => $('fileInputConfig').click();
        $('fileInputConfig').onchange = e => {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = evt => {
                try {
                    const d = JSON.parse(evt.target.result);
                    if(d.kind !== 'table-tool-config') throw new Error();

                    // 更新全局视图
                    if(d.globalViews) {
                        const oldCount = Store.state.globalViews.length;
                        Store.state.globalViews = d.globalViews;
                        Toast.show(`全局视图已更新 (${oldCount} → ${d.globalViews.length} 个)`, false, 2000);
                    }

                    // 更新文档配置
                    if(d.docs && d.docs.length > 0) {
                        let appliedCount = 0;
                        let ignoredDocs = [];
                        let createdDocs = [];

                        d.docs.forEach(x => {
                            // 优先使用 title 匹配（更符合用户预期），如果 title 不存在才用 id 匹配
                            let t = Store.state.docs.find(y => y.title === x.title);
                            if(!t) t = Store.state.docs.find(y => y.id === x.id);

                            if(t) {
                                // 匹配到文档，更新配置
                                t.ui = x.ui;
                                appliedCount++;
                            } else {
                                // 没有匹配到，记录下来
                                ignoredDocs.push(x.title || x.id);
                            }
                        });

                        // 如果有被忽略的配置，询问用户是否创建新文档
                        if(ignoredDocs.length > 0) {
                            const msg = `配置导入完成：\n• 已应用 ${appliedCount} 个文档的配置\n• ${ignoredDocs.length} 个配置无法匹配（${ignoredDocs.slice(0, 3).join(', ')}${ignoredDocs.length > 3 ? '...' : ''}）\n\n是否为这些配置创建新文档？`;

                            if(confirm(msg)) {
                                ignoredDocs.forEach((docName, idx) => {
                                    const config = d.docs.find(dc => (dc.title === docName) || (dc.id === docName));
                                    if(config) {
                                        const newDoc = {
                                            id: Date.now().toString() + '_' + idx,
                                            title: config.title,
                                            raw: '',
                                            ui: config.ui
                                        };
                                        Store.state.docs.push(newDoc);
                                        createdDocs.push(config.title);
                                    }
                                });

                                Store.save();
                                App.renderTabs();
                                App.loadDoc();

                                if(createdDocs.length > 0) {
                                    Toast.show(`配置已更新，新增 ${createdDocs.length} 个文档`, false, 3000);
                                }
                            } else {
                                Store.save();
                                App.loadDoc();
                                Toast.show(`配置已更新（应用了 ${appliedCount} 个文档）`, false, 2000);
                            }
                        } else {
                            // 所有配置都成功应用
                            Store.save();
                            App.loadDoc();
                            Toast.show(`配置已更新（应用了 ${appliedCount} 个文档）`, false, 2000);
                        }
                    } else {
                        Store.save();
                        App.loadDoc();
                        Toast.show('配置已更新');
                    }
                } catch(e) {
                    console.error(e);
                    alert('配置文件格式错误，请检查文件是否完整');
                }
                e.target.value = '';
            };
            r.readAsText(f);
        };
        
        // Editor Bindings
        const closeJoin = () => JoinEditor.close();
        $('jeCancel').onclick = closeJoin;
        $('jeCancelFooter').onclick = closeJoin;
        $('jeSave').onclick = () => JoinEditor.save();
        $('jeSaveFooter').onclick = () => JoinEditor.save();
        $('jeAddRel').onclick = () => JoinEditor.addRel();
        $('jeAutoRel').onclick = () => JoinEditor.autoMatchRels();
        $('jeOrderRebuild').onclick = () => JoinEditor.rebuildOrder();
        $('jeOrderClear').onclick = () => JoinEditor.clearOrder();
        $('jeOrderLeftOnly').onclick = () => JoinEditor.keepOnly('l');
        $('jeOrderRightOnly').onclick = () => JoinEditor.keepOnly('r');
        $('jeOrderShowL').onchange = e => { JoinEditor.state.showL = e.target.checked; JoinEditor.renderSelectedOrder(); };
        $('jeOrderShowR').onchange = e => { JoinEditor.state.showR = e.target.checked; JoinEditor.renderSelectedOrder(); };

        $('jeLeftTable').onchange = () => JoinEditor.handleTableChange('l');
        $('jeRightTable').onchange = () => JoinEditor.handleTableChange('r');
        $('jeType').onchange = () => { JoinEditor.markDirty(); JoinEditor.updateAll(); };
        $('jeName').oninput = () => { JoinEditor.markDirty(); JoinEditor.updateSaveState(); };

        $('jeLSearch').oninput = () => JoinEditor.renderColList('jeLList', App.getCols($('jeLeftTable').value), JoinEditor.state.lSel, 'l');
        $('jeRSearch').oninput = () => JoinEditor.renderColList('jeRList', App.getCols($('jeRightTable').value), JoinEditor.state.rSel, 'r');
        $('jeLAll').onclick = () => JoinEditor.toggleAll('l');
        $('jeRAll').onclick = () => JoinEditor.toggleAll('r');
        $('jeLAllFiltered').onclick = () => JoinEditor.selectFiltered('l');
        $('jeRAllFiltered').onclick = () => JoinEditor.selectFiltered('r');
        $('jeLOnlySel').onchange = e => { JoinEditor.state.lOnlySel = e.target.checked; JoinEditor.renderColList('jeLList', App.getCols($('jeLeftTable').value), JoinEditor.state.lSel, 'l'); };
        $('jeROnlySel').onchange = e => { JoinEditor.state.rOnlySel = e.target.checked; JoinEditor.renderColList('jeRList', App.getCols($('jeRightTable').value), JoinEditor.state.rSel, 'r'); };
        const helpToggle = $('jeHelpToggle');
        const helpBody = $('jeHelpBody');
        if(helpToggle && helpBody) {
            helpToggle.onclick = () => helpBody.classList.toggle('show');
        }
        const jm = $('joinModal');
        if(jm) jm.addEventListener('click', e => { if(e.target === jm) closeJoin(); });

        document.addEventListener('keydown', e => {
            if($('joinModal').classList.contains('hidden')) return;
            if(!$('modalOverlay').classList.contains('hidden')) return;
            if(e.key === 'Escape') { e.preventDefault(); JoinEditor.close(); }
            if(e.key === '/' && !/INPUT|TEXTAREA|SELECT/.test(document.activeElement.tagName)) { e.preventDefault(); $('jeLSearch').focus(); }
            if(e.key === 'Enter' && !e.shiftKey) { JoinEditor.save(); }
        });

        // Filter popover bindings
        this.initFilterPopover();

        // Cell inline editing
        $('previewArea').addEventListener('dblclick', e => {
            const td = e.target.closest('td');
            if(!td || !td.closest('table')) return;
            e.stopPropagation();
            Select.clear();
            this.startCellEdit(td);
        });
    },

    loadDoc() {
        const d = Store.curr();
        $('rawInput').value = d.raw || '';
        $('globalFilter').value = d.ui.globalFilter || '';
        $('checkHl').checked = d.ui.enableHighlight !== false;
        $('checkOnlyHl').checked = d.ui.onlyHighlighted || false;
        this.run(false);
        this.renderPreview();
    },

    run(render=true) {
        try {
            Store.curr().raw = $('rawInput').value; Store.save();
            this.raw = Parser.parse($('rawInput').value);
            this.updSelects();
            if(render) this.renderPreview();
            this.updChips();
        } catch(e) {
            console.error(e);
            Toast.show("解析错误: " + e.message, true);
        }
    },

    updSelects() {
        const s = $('targetTableSelect');
        const old = s.value; s.innerHTML = '';
        this.raw.forEach(t => s.add(new Option(t.name, t.name)));
        Store.state.globalViews.forEach(v => s.add(new Option(`JOIN:${v.view}`, `JOIN:${v.view}`)));
        if(old && Array.from(s.options).some(o=>o.value===old)) s.value=old;
        else if(s.options.length>0) s.selectedIndex=0;
        this.syncRules();
    },

    syncRules() {
        const t = $('targetTableSelect').value;
        const r = Store.curr().ui.rules[t] || {};
        $('hlInput').value = r.hl || '';
        $('filterInput').value = r.filter || '';
        $('focusColsInput').value = (r.focus || []).join(', ');
    },

    updChips() {
        const ui = Store.curr().ui;
        // 只显示表/视图名称，过滤掉误保存的字段名
        const tableNames = this.raw.map(t => t.name);
        const tsRaw = ui.displayTables;
        const ts = (tsRaw===null || tsRaw===undefined) ? null : (tsRaw || []).filter(n => tableNames.includes(n));
        $('tablesTrigger').innerHTML = (ts===null) ? `<span class="chip" style="background:var(--bg-hover); color:var(--text-secondary); border-color:transparent;">默认全显</span>` : (ts.length ? ts.map(n=>`<span class="chip">${n}</span>`).join('') : `<span class="placeholder">无</span>`);
        const viewNames = Store.state.globalViews.map(v => v.view);
        const vsRaw = ui.enabledViews || [];
        const vs = vsRaw.filter(v => viewNames.includes(v));
        if(vs.length !== vsRaw.length) Store.updateUI('enabledViews', vs);
        $('viewsTrigger').innerHTML = vs.length ? vs.map(n=>`<span class="chip">${n}</span>`).join('') : `<span class="placeholder">未启用</span>`;
    },

    renderTabs() {
        // Correctly handle tab close
        $('tabsContainer').innerHTML = Store.state.docs.map(d => `<div class="doc-tab ${d.id===Store.state.activeId?'active':''}" data-id="${d.id}"><span>${d.title}</span><span class="doc-tab-close">×</span></div>`).join('');
    },

    renderPreview() {
        if(this.activeEditor) this.finishCellEdit(true);
        const div = $('previewArea'); div.innerHTML = '';
        this.rendered = []; Select.clear();
        if(!this.raw.length) { 
            div.innerHTML = `<div class="empty">
                <svg viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="15" y="25" width="90" height="70" rx="12" stroke="currentColor" stroke-opacity="0.25" stroke-width="4" stroke-dasharray="6 8"/>
                    <rect x="30" y="40" width="60" height="16" rx="6" fill="currentColor" fill-opacity="0.12"/>
                    <rect x="30" y="62" width="40" height="10" rx="5" fill="currentColor" fill-opacity="0.12"/>
                    <rect x="30" y="78" width="50" height="10" rx="5" fill="currentColor" fill-opacity="0.12"/>
                </svg>
                <div style="font-weight:700;">等待解析数据</div>
                <div class="muted">粘贴数据后点击“解析”。需要示例？点击左侧提示</div>
            </div>`; 
            return; 
        }
        
        const ui = Store.curr().ui;
        let list = this.raw;
        if(ui.displayTables) list = list.filter(t=>ui.displayTables.includes(t.name));
        
        let joins = [];
        if(ui.enabledViews) {
            joins = ui.enabledViews.map(v => {
                const cfg = Store.state.globalViews.find(g=>g.view===v);
                return cfg ? Joiner.run(this.raw, cfg, Store.state.globalViews) : null;
            }).filter(x=>x);
        }
        const combined = [...list, ...joins];
        if(!combined.length) {
            div.innerHTML = `<div class="empty">
                <svg viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M25 35h70v50H25z" stroke="currentColor" stroke-opacity="0.3" stroke-width="4" stroke-dasharray="6 8"/>
                    <path d="M36 52h48" stroke="currentColor" stroke-opacity="0.35" stroke-width="6" stroke-linecap="round"/>
                    <path d="M36 68h32" stroke="currentColor" stroke-opacity="0.3" stroke-width="6" stroke-linecap="round"/>
                </svg>
                <div style="font-weight:700;">当前筛选下无可见表</div>
                <div class="muted">检查“显示原始表 / JOIN 视图”的选择</div>
            </div>`;
            return;
        }

        combined.forEach((t, tIdx) => {
            const res = this.proc(t, ui);
            this.rendered.push({name: t.name, ...res}); 
            const colFilters = (ui.columnFilters && ui.columnFilters[t.name]) || {};
            const filterCount = Object.values(colFilters).filter(v => (v ?? '').toString().trim()).length;
            const isCollapsed = ui.collapsedTables && ui.collapsedTables[t.name];

            const card = createEl('div', 'table-container');
            const meta = createEl('div', 'table-meta');
            meta.ondblclick = () => this.toggleTableCollapse(t.name);
            const nameSpan = createEl('span');
            nameSpan.style.fontWeight = '800';
            nameSpan.style.color = 'var(--text-strong)';
            nameSpan.textContent = t.name;
            meta.appendChild(nameSpan);
            if(t.isView) {
                const badge = createEl('span', 'meta-tag'); badge.style.color='var(--primary)'; badge.style.background='var(--primary-soft)'; badge.textContent='VIEW'; meta.appendChild(badge);
            }
            const rowTag = createEl('span', 'meta-tag'); rowTag.textContent = `Row: ${t.rows.length}`; meta.appendChild(rowTag);
            const showTag = createEl('span', 'meta-tag'); showTag.textContent = `Show: ${res.rows.length}`; meta.appendChild(showTag);
            if(filterCount>0) { 
                const fTag = createEl('span','meta-tag'); 
                fTag.textContent = `列过滤: ${filterCount}`; 
                fTag.style.cursor = 'pointer';
                fTag.title = '清除本表全部列过滤';
                fTag.onclick = () => this.clearTableFilters(t.name);
                meta.appendChild(fTag); 
            }
            card.appendChild(meta);
            if(isCollapsed) { div.appendChild(card); return; }

            const tbl = createEl('table'); tbl.dataset.idx = tIdx;
            const thRow = createEl('tr');
            res.headers.forEach(h => { 
                const th=createEl('th'); 
                th.classList.add('filterable-th');
                const hasFilter = colFilters[h] && colFilters[h].toString().trim();
                th.title= hasFilter ? `已过滤：${colFilters[h]}` : '点击过滤该列（包含匹配，忽略大小写）';
                if(hasFilter) th.style.color = 'var(--primary)';
                const label = createEl('span','th-label');
                label.textContent = h;
                if(hasFilter) {
                    const dot = createEl('span','th-filter-dot');
                    label.appendChild(dot);
                    const clearBtn = createEl('span','th-filter-clear');
                    clearBtn.textContent = '×';
                    clearBtn.title = '清除该列过滤';
                    clearBtn.onclick = (ev) => { ev.stopPropagation(); this.clearColumnFilter(t.name, h); };
                    th.appendChild(clearBtn);
                }
                th.appendChild(label);
                th.onclick = (ev) => { ev.stopPropagation(); this.promptColumnFilter(t.name, h, th); };
                thRow.appendChild(th); 
            });
            const thead = createEl('thead'); thead.appendChild(thRow); tbl.appendChild(thead);
            const tbody = createEl('tbody');
            res.rows.forEach((r, rIdx) => {
                const tr = createEl('tr');
                if(r._hl) tr.className = 'highlight-row';
                r.d.forEach((c, cIdx) => { 
                    const td=createEl('td'); 
                    const v = c===undefined||c===null?'':c; 
                    td.textContent=v; 
                    if(String(v).length > 18) td.dataset.full=v; 
                    td.dataset.r=rIdx; td.dataset.c=cIdx; 
                    tr.appendChild(td); 
                });
                tbody.appendChild(tr);
            });
            tbl.appendChild(tbody); card.appendChild(tbl); div.appendChild(card);
        });
    },

    initFilterPopover() {
        const pop = $('filterPopover');
        if(!pop) return;
        const title = $('fpTitle');
        const input = $('fpInput');
        const btnApply = $('fpApply');
        const btnClear = $('fpClear');
        const btnClose = $('fpClose');
        const hide = () => { pop.classList.add('hidden'); this.filterPopover = {open:false, table:null, col:null, pop, input, title}; };
        this.filterPopover.pop = pop;
        this.filterPopover.input = input;
        this.filterPopover.title = title;
        btnClose.onclick = hide;
        btnClear.onclick = () => {
            if(!this.filterPopover.table || !this.filterPopover.col) { hide(); return; }
            const ui = Store.curr().ui;
            if(ui.columnFilters && ui.columnFilters[this.filterPopover.table]) {
                delete ui.columnFilters[this.filterPopover.table][this.filterPopover.col];
            }
            Store.save();
            hide();
            this.renderPreview();
        };
        btnApply.onclick = () => {
            if(!this.filterPopover.table || !this.filterPopover.col) { hide(); return; }
            const val = (input.value || '').trim();
            const ui = Store.curr().ui;
            if(!ui.columnFilters) ui.columnFilters = {};
            if(!ui.columnFilters[this.filterPopover.table]) ui.columnFilters[this.filterPopover.table] = {};
            if(val) ui.columnFilters[this.filterPopover.table][this.filterPopover.col] = val;
            else delete ui.columnFilters[this.filterPopover.table][this.filterPopover.col];
            Store.save();
            hide();
            this.renderPreview();
        };
        document.addEventListener('click', e => {
            if(!this.filterPopover.open) return;
            if(pop.contains(e.target)) return;
            const th = e.target.closest && e.target.closest('.filterable-th');
            if(th) return; // allow new popover open handler to manage
            hide();
        });
        document.addEventListener('keydown', e => {
            if(e.key === 'Escape' && this.filterPopover.open) hide();
        });
        const preview = $('previewArea');
        if(preview) preview.addEventListener('scroll', () => { if(this.filterPopover.open) hide(); });
        this.filterPopover.hide = hide;
    },

    promptColumnFilter(tableName, colName, anchorEl) {
        if(this.filterPopover.open && this.filterPopover.hide) this.filterPopover.hide();
        const pop = this.filterPopover.pop;
        const input = this.filterPopover.input;
        const title = this.filterPopover.title;
        if(!pop || !input || !title) return;
        const ui = Store.curr().ui;
        const prev = ((ui.columnFilters && ui.columnFilters[tableName] && ui.columnFilters[tableName][colName]) || '').toString();
        input.value = prev;
        title.textContent = `${tableName}.${colName}`;
        this.filterPopover.open = true;
        this.filterPopover.table = tableName;
        this.filterPopover.col = colName;
        pop.classList.remove('hidden');

        // Position near header
        const rect = anchorEl.getBoundingClientRect();
        const popRect = pop.getBoundingClientRect();
        const top = Math.max(10, rect.bottom + 6);
        let left = rect.left;
        const maxLeft = window.innerWidth - popRect.width - 10;
        if(left > maxLeft) left = maxLeft;
        if(left < 10) left = 10;
        pop.style.top = `${top}px`;
        pop.style.left = `${left}px`;
        input.focus();
        input.select();
    },

    clearColumnFilter(tableName, colName) {
        const ui = Store.curr().ui;
        if(ui.columnFilters && ui.columnFilters[tableName]) {
            delete ui.columnFilters[tableName][colName];
        }
        Store.save();
        if(this.filterPopover.hide) this.filterPopover.hide();
        this.renderPreview();
    },

    clearTableFilters(tableName) {
        const ui = Store.curr().ui;
        if(ui.columnFilters) {
            delete ui.columnFilters[tableName];
            Store.save();
            if(this.filterPopover.hide) this.filterPopover.hide();
            this.renderPreview();
        }
    },

    toggleTableCollapse(tableName) {
        const ui = Store.curr().ui;
        if(!ui.collapsedTables) ui.collapsedTables = {};
        ui.collapsedTables[tableName] = !ui.collapsedTables[tableName];
        Store.save();
        this.renderPreview();
    },

    startCellEdit(td) {
        if(this.activeEditor) this.finishCellEdit(true);
        const tbl = td.closest('table');
        const tIdx = parseInt(tbl.dataset.idx, 10);
        const rIdx = parseInt(td.dataset.r, 10);
        const cIdx = parseInt(td.dataset.c, 10);
        const orig = td.textContent;
        const origHeight = td.getBoundingClientRect().height;
        td.style.height = `${origHeight}px`;
        td.style.minHeight = `${origHeight}px`;
        td.classList.add('editing');

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'cell-editor';
        input.value = orig;
        td.innerHTML = '';
        td.appendChild(input);
        input.focus();
        input.select();

        const cancel = () => {
            td.removeChild(input);
            td.textContent = orig;
            td.style.height = '';
            td.style.minHeight = '';
            td.classList.remove('editing');
            this.activeEditor = null;
        };
        const commit = () => {
            const val = input.value;
            td.removeChild(input);
            td.textContent = val;
            if(String(val).length > 18) td.dataset.full = val; else td.removeAttribute('data-full');
            if(this.rendered[tIdx] && this.rendered[tIdx].rows[rIdx]) {
                this.rendered[tIdx].rows[rIdx].d[cIdx] = val;
            }
            td.style.height = '';
            td.style.minHeight = '';
            td.classList.remove('editing');
            this.activeEditor = null;
        };

        const onKey = (e) => {
            if(e.key === 'Enter' || e.key === 'Tab') { e.preventDefault(); commit(); }
            else if(e.key === 'Escape') { e.preventDefault(); cancel(); }
        };
        input.addEventListener('keydown', onKey);
        input.addEventListener('blur', commit, { once: true });
        this.activeEditor = { td, input, orig, commit, cancel };
    },

    finishCellEdit(commit=true) {
        if(!this.activeEditor) return;
        const { commit: doCommit, cancel } = this.activeEditor;
        if(commit) doCommit(); else cancel();
        this.activeEditor = null;
    },

    proc(t, ui) {
        const r = ui.rules[t.name] || {};
        let head = t.headers, idxs = t.headers.map((_,i)=>i);
        if(r.focus && r.focus.length) {
            head=[]; idxs=[];
            r.focus.forEach(c => { const i=t.headers.indexOf(c); if(i>-1){ head.push(c); idxs.push(i); } });
            if(!head.length) { head=t.headers; idxs=t.headers.map((_,i)=>i); }
        }

        const hMap = new Map(t.headers.map((h, i) => [h.toLowerCase(), i]));
        const colFilterMap = (ui.columnFilters && ui.columnFilters[t.name]) || {};
        const activeColFilters = Object.entries(colFilterMap).filter(([,v]) => (v ?? '').toString().trim());

        // --- SMART FILTER LOGIC ---
        const checkToken = (token, row) => {
            const opMatch = token.match(/^(.+?)(!=|>=|<=|=|>|<|:)(.+)$/);
            if (opMatch) {
                const key = opMatch[1].toLowerCase();
                const op = opMatch[2];
                const val = opMatch[3].toLowerCase();
                const idx = hMap.get(key);
                if (idx === undefined) return false;
                
                let cellVal = (row[idx] || "").toLowerCase();
                const numC = parseFloat(cellVal);
                const numV = parseFloat(val);
                const isNum = !isNaN(numC) && !isNaN(numV);

                switch(op) {
                    case '=': return cellVal === val; 
                    case ':': return cellVal.includes(val); 
                    case '!=': return cellVal !== val;
                    case '>': return isNum && numC > numV;
                    case '>=': return isNum && numC >= numV;
                    case '<': return isNum && numC < numV;
                    case '<=': return isNum && numC <= numV;
                }
            }
            if (token.startsWith('/') && token.endsWith('/')) {
                try { return new RegExp(token.slice(1, -1), 'i').test(row.join(' ')); } catch (e) { return false; }
            }
            return row.join(' ').toLowerCase().includes(token.toLowerCase());
        };

        const checkRule = (ruleStr, row) => {
            if (!ruleStr) return true;
            const tokens = ruleStr.trim().split(/\s+/);
            return tokens.every(t => {
                if (t.includes('|')) return t.split('|').some(st => checkToken(st, row));
                return checkToken(t, row);
            });
        };

        const gF = (ui.globalFilter||'');
        const tF = (r.filter||'');
        const hlF = (r.hl||'');

        const rows = [];
        t.rows.forEach(row => {
            if(gF && !checkRule(gF, row)) return;
            if(tF && !checkRule(tF, row)) return;
            if(activeColFilters.length) {
                const pass = activeColFilters.every(([col, val]) => {
                    const idx = t.headers.indexOf(col);
                    if(idx===-1) return true;
                    const cell = row[idx];
                    return (cell ?? '').toString().toLowerCase().includes(val.toString().toLowerCase());
                });
                if(!pass) return;
            }
            let hl = false;
            if(ui.enableHighlight!==false && hlF && checkRule(hlF, row)) hl = true;
            if(ui.onlyHighlighted && !hl) return;
            rows.push({ d: idxs.map(i=>row[i]), _hl: hl });
        });
        return { headers: head, rows };
    },

    modal(title, html) {
        $('modalContent').innerHTML = `<div class="panel-header" style="border-radius:8px 8px 0 0;">${title} <button class="icon-btn" onclick="document.getElementById('modalOverlay').classList.add('hidden')">×</button></div><div style="padding:16px; overflow-y:auto; flex:1;">${html}</div>`;
        $('modalOverlay').classList.remove('hidden');
    },

    modTables() {
        const ts = this.raw.map(t=>t.name);
        const selSaved = Store.curr().ui.displayTables;
        const sel = (selSaved===null || selSaved===undefined) ? ts : selSaved;
        const h = ts.map(t => `<label class="checkbox-row"><input type="checkbox" value="${t}" ${sel.includes(t)?'checked':''}><span>${t}</span></label>`).join('');
        this.modal('选择显示表', `<div>${h}</div><div style="margin-top:16px; text-align:right;"><button class="primary" id="saveMod">确定</button></div>`);
        $('saveMod').onclick = () => {
            const v = Array.from(document.querySelectorAll('.checkbox-row input:checked')).map(c=>c.value);
            // v.length===ts.length 但 ts 为空时，保持空数组代表“全不选”
            const next = (v.length===ts.length && ts.length>0) ? null : v;
            Store.updateUI('displayTables', next); $('modalOverlay').classList.add('hidden'); this.run();
        };
    },
    modViews() {
        const vs = Store.state.globalViews, sel = Store.curr().ui.enabledViews || [];
        if(!vs.length) return alert('请先管理视图');
        const h = vs.map(v => {
            const name = v.view || '(未命名视图)';
            const meta = (v.left && v.right) ? `<span style="font-size:11px; color:var(--text-tertiary); margin-left:6px;">${v.left} ⇔ ${v.right}</span>` : '';
            return `<label class="checkbox-row"><input type="checkbox" value="${name}" ${sel.includes(name)?'checked':''}><span style="font-weight:600; color:var(--text-main);">${name}</span>${meta}</label>`;
        }).join('');
        this.modal('启用视图', `<div>${h}</div><div style="margin-top:16px; text-align:right;"><button class="primary" id="saveMod">确定</button></div>`);
        $('saveMod').onclick = () => {
            Store.updateUI('enabledViews', Array.from(document.querySelectorAll('.checkbox-row input:checked')).map(c=>c.value));
            $('modalOverlay').classList.add('hidden'); this.run();
        };
    },

    modCols() {
        const tName = $('targetTableSelect').value;
        if(!tName) return;

        // Get columns for the selected table
        const rawTable = this.raw.find(x => x.name === tName);
        let all = rawTable ? rawTable.headers : [];

        if(!all.length && tName.startsWith('JOIN:')) {
            const vName = tName.replace('JOIN:', '');
            const vCfg = Store.state.globalViews.find(v => v.view === vName);
            if(vCfg) {
                const res = Joiner.run(this.raw, vCfg, Store.state.globalViews);
                if(res) all = res.headers;
            }
        }
        if(!all.length) {
            const rt = this.rendered.find(x => x.name === tName);
            if(rt) all = rt.headers;
        }
        if(!all.length) return alert('无法获取列信息');

        const rule = Store.curr().ui.rules[tName] || {};
        const cur = (rule.focus && rule.focus.length > 0) ? rule.focus : all;
        const isFocusActive = (rule.focus && rule.focus.length > 0);

        const html = `
            <div style="margin-bottom:10px; display:flex; gap:8px;">
                <input id="colSearch" placeholder="搜索列名..." style="flex:1;">
                <button class="sm" id="colAll">全选</button>
                <button class="sm" id="colNone">全不选</button>
            </div>
            <div id="colList" style="max-height:400px; overflow-y:auto; border:1px solid var(--border-light); padding:8px; border-radius:4px;">
                ${all.map(c => `<label class="checkbox-row" data-val="${c.toLowerCase()}"><input type="checkbox" value="${c}" ${!isFocusActive || cur.includes(c)?'checked':''}><span>${c}</span></label>`).join('')}
            </div>
            <div style="margin-top:16px; text-align:right;"><button class="primary" id="saveMod">应用</button></div>
        `;
        this.modal(`选择列: ${tName}`, html);
        const list = $('colList');
        $('colSearch').oninput = e => {
            const v = e.target.value.toLowerCase();
            Array.from(list.children).forEach(r => r.style.display = r.dataset.val.includes(v) ? 'flex' : 'none');
        };
        $('colAll').onclick = () => {
            Array.from(list.children).forEach(r => {
                if(r.style.display !== 'none') r.querySelector('input').checked = true;
            });
        };
        $('colNone').onclick = () => {
            Array.from(list.children).forEach(r => {
                if(r.style.display !== 'none') r.querySelector('input').checked = false;
            });
        };
        $('saveMod').onclick = () => {
            const v = Array.from(list.querySelectorAll('input:checked')).map(c => c.value);
            Store.updateRule(tName, 'focus', v);
            $('focusColsInput').value = v.join(', ');
            $('modalOverlay').classList.add('hidden');
            this.renderPreview();
        };
    }
};

App.init();
</script>
</body>
</html>
